<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitTrack</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A6FA5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FitTrack">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-152x152.png">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="icons/icon-512x512.png">
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-moment/1.0.1/chartjs-adapter-moment.min.js"></script>
    <style>
        :root {
            --primary: #4A6FA5;
            --secondary: #728FCE;
            --accent: #95B9C7;
            --light: #F0F8FF;
            --dark: #333;
            --success: #4CAF50;
            --warning: #FFA500;
            --danger: #DC3545;
            
            /* Add responsive spacing variables */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Add responsive font sizes */
            --font-size-sm: clamp(0.8rem, 1.5vw, 0.9rem);
            --font-size-base: clamp(1rem, 2vw, 1.1rem);
            --font-size-lg: clamp(1.2rem, 2.5vw, 1.4rem);
            --font-size-xl: clamp(1.5rem, 3vw, 1.8rem);
            
            /* Add these mobile-optimized styles after the existing root variables */
            --header-height: clamp(60px, 10vh, 80px);
            --container-padding: clamp(10px, 3vw, 20px);
            --element-spacing: clamp(8px, 2vw, 16px);
            --card-border-radius: 12px;
            
            /* Mobile-optimized touch targets */
            --min-touch-target: 44px;
            --safe-bottom-padding: env(safe-area-inset-bottom, 20px);
            --nav-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background-color: var(--light);
            font-size: var(--font-size-base);
        }

        /* Enhance base container styles */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--container-padding);
            width: 100%;
            box-sizing: border-box;
            transition: max-width 0.3s ease;
        }

        /* Add device emulation toggle styles */
        .device-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 9999;
            font-size: 14px;
            display: none;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .device-toggle:hover {
            background: var(--secondary);
        }

        /* Only show toggle on desktop */
        @media (min-width: 769px) {
            .device-toggle {
                display: block;
            }
            
            .mobile-nav {
                display: none;
            }

            .tabs {
                display: flex;
            }
            
            body.mobile-preview {
                background: #f0f0f0;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
                padding-top: 20px;
                padding-bottom: calc(var(--nav-height) + env(safe-area-inset-bottom, 20px));
            }
            
            body.mobile-preview .container {
                max-width: 390px;
                border-radius: 20px;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                background: white;
                margin: 0 auto;
                margin-bottom: var(--nav-height);
            }

            body.mobile-preview .tabs {
                display: none !important;
            }

            body.mobile-preview .mobile-nav {
                display: block;
                max-width: 390px;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            .container {
                padding-bottom: calc(var(--nav-height) + env(safe-area-inset-bottom, 20px));
            }
            
            .tabs {
                display: none !important;
            }
            
            .mobile-nav {
                display: block;
            }
        }

        h1 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--spacing-lg);
            color: var(--primary);
        }

        /* Enhanced responsive grid system */
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--element-spacing);
            margin: calc(-1 * var(--element-spacing) / 2);
        }

        .col {
            flex: 1 1 300px;
            padding: calc(var(--element-spacing) / 2);
            min-width: 0;
        }

        /* Mobile-specific media queries */
        @media (max-width: 768px) {
            .row {
                margin: 0;
            }
            
            .col {
                flex: 1 1 100%;
                padding: calc(var(--element-spacing) / 2) 0;
            }
            
            .modal-content {
                padding: var(--container-padding);
                margin: 0;
                border-radius: var(--card-border-radius) var(--card-border-radius) 0 0;
                max-height: 95vh;
            }
            
            .history-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .history-table th,
            .history-table td {
                min-width: 120px;
                white-space: nowrap;
            }
            
            .workout-options-container {
                grid-template-columns: 1fr;
                gap: var(--element-spacing);
            }
            
            .day-selector {
                padding: calc(var(--element-spacing) / 2);
                margin: calc(-1 * var(--element-spacing) / 2);
            }
        }

        @media (max-width: 480px) {
            h1 {
                text-align: center;
                margin-bottom: var(--spacing-md);
            }
            
            .form-group {
                margin-bottom: var(--spacing-sm);
            }
        }

        /* Add smooth transitions */
        .day-card,
        .workout-option,
        button,
        input,
        select {
            transition: all 0.2s ease-in-out;
        }
        
        :root {
            --white: #ffffff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        h1, h2, h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        h1 {
            text-align: center;
            border-bottom: 2px solid var(--light);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        section {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--secondary);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 5px rgba(76, 181, 245, 0.5);
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary);
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .edit-entry, .delete-entry {
            padding: 5px 10px;
            margin: 0 5px;
            font-size: 14px;
        }
        
        .edit-entry {
            background-color: var(--accent);
        }
        
        .delete-entry {
            background-color: var(--danger);
        }
        
        .row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .col {
            flex: 1;
            min-width: 200px;
        }
        
        .workout-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .workout-item {
            background-color: var(--light);
            padding: 5px 10px;
            border-radius: 15px;
            display: flex;
            align-items: center;
        }
        
        .workout-item span {
            margin-right: 5px;
        }
        
        .workout-item button {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0;
            font-size: 16px;
        }
        
        .stats-card {
            background-color: var(--white);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .stats-card h3 {
            border-bottom: 1px solid var(--light);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .history-table th, .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .history-table th {
            background-color: var(--light);
            color: var(--dark);
        }
        
        .history-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .tabs {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
            gap: var(--element-spacing);
            padding: var(--element-spacing) 0;
            margin: -var(--element-spacing) 0;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
            border-bottom: 1px solid var(--light);
        }
        
        .tab {
            scroll-snap-align: start;
            white-space: nowrap;
            padding: calc(var(--element-spacing) * 1.5);
            min-height: var(--min-touch-target);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--card-border-radius);
            background: transparent;
            transition: all 0.2s ease;
            color: var(--secondary);
            position: relative;
            flex: 0 0 auto;
        }
        
        .tab.active {
            color: var(--primary);
            background: rgba(74, 111, 165, 0.1);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Welcome tab styles */
        .highlights-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .highlight-card {
            background-color: var(--white);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .highlight-card:hover {
            transform: translateY(-3px);
        }
        
        .highlight-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }
        
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .quick-actions button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .quick-actions button:hover {
            transform: scale(1.02);
        }
        
        #welcome-workout {
            min-height: 100px;
        }
        
        #welcome-workout .workout-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        #welcome-workout .workout-status.planned {
            background-color: var(--light);
            color: var(--dark);
        }
        
        #welcome-workout .workout-status.completed {
            background-color: var(--success);
            color: white;
        }
        
        #welcome-workout .workout-status.in-progress {
            background-color: var(--warning);
            color: white;
        }
        
        #welcome-workout .exercise-list {
            margin-top: 10px;
            font-size: 14px;
            color: var(--secondary);
        }
        
        /* Workout plan styles */
        .day-selector {
            display: flex;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .day-card {
            background-color: var(--light);
            border-radius: 8px;
            padding: 15px;
            min-width: 100px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .day-card.active {
            background-color: var(--primary);
            color: white;
        }
        
        .day-card h3 {
            margin-bottom: 5px;
            color: inherit;
        }
        
        .exercise-card {
            background-color: var(--white);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .exercise-card .actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
        }
        
        .exercise-card .actions button {
            padding: 5px;
            font-size: 12px;
        }
        
        .exercise-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .exercise-detail {
            display: flex;
            flex-direction: column;
        }
        
        .exercise-detail span {
            font-weight: bold;
            color: var(--secondary);
        }
        
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: var(--accent);
            color: white;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .mesocycle-weeks {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            gap: 20px;
        }
        
        .mesocycle-week {
            min-width: 200px;
            background-color: var(--white);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-btn {
            margin-bottom: 15px;
            border: 1px solid var(--accent);
            border-radius: 5px;
            overflow: hidden;
            display: inline-flex;
        }
        
        .toggle-btn button {
            border-radius: 0;
            padding: 8px 15px;
            background-color: var(--white);
            color: var(--secondary);
            border: none;
        }
        
        .toggle-btn button.active {
            background-color: var(--accent);
            color: white;
        }
        
        .card-notice {
            background-color: #fcf8e3;
            color: #8a6d3b;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #f39c12;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .badge-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: flex-end; /* Default to bottom sheet on mobile */
            justify-content: center;
            padding: 0;
            animation: modal-overlay-fade-in 0.2s ease;
        }
        
        .modal-content {
            background: var(--white);
            padding: calc(var(--element-spacing) * 2);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border-radius: var(--card-border-radius) var(--card-border-radius) 0 0;
            animation: modal-slide-up 0.3s ease;
            transform-origin: bottom center;
        }
        
        /* Modal animations */
        @keyframes modal-overlay-fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes modal-slide-up {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        /* Modal header */
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--element-spacing) * 2);
            padding-bottom: var(--element-spacing);
            border-bottom: 1px solid var(--light);
        }
        
        .modal-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--dark);
            margin: 0;
        }
        
        .modal-close {
            width: var(--min-touch-target);
            height: var(--min-touch-target);
            padding: 0;
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            color: var(--dark);
        }
        
        /* Modal body */
        .modal-body {
            margin-bottom: calc(var(--element-spacing) * 2);
        }
        
        /* Modal footer */
        .modal-footer {
            display: flex;
            gap: var(--element-spacing);
            justify-content: flex-end;
            margin-top: auto;
            padding-top: calc(var(--element-spacing) * 2);
            border-top: 1px solid var(--light);
        }
        
        /* Drag handle for mobile */
        .modal-drag-handle {
            display: none;
            width: 40px;
            height: 4px;
            background: var(--light);
            border-radius: 2px;
            margin: 0 auto calc(var(--element-spacing) * 2);
        }
        
        /* Desktop styles */
        @media (min-width: 769px) {
            .modal {
                align-items: center;
                padding: var(--element-spacing);
            }
            
            .modal-content {
                border-radius: var(--card-border-radius);
                animation: modal-fade-in 0.3s ease;
                max-height: 85vh;
            }
            
            @keyframes modal-fade-in {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            .modal-content {
                padding: calc(var(--element-spacing) * 1.5);
                max-height: 95vh;
            }
            
            .modal-drag-handle {
                display: block;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer button {
                width: 100%;
            }
            
            /* Safe area insets for modern iOS devices */
            @supports(padding: max(0px)) {
                .modal-content {
                    padding-bottom: max(calc(var(--element-spacing) * 1.5), env(safe-area-inset-bottom));
                }
            }
            
            /* Prevent body scroll when modal is open */
            body.modal-open {
                overflow: hidden;
                position: fixed;
                width: 100%;
            }
        }
        
        /* Modal transition states */
        .modal.closing {
            animation: modal-overlay-fade-out 0.2s ease forwards;
        }
        
        .modal.closing .modal-content {
            animation: modal-slide-down 0.2s ease forwards;
        }
        
        @keyframes modal-overlay-fade-out {
            to {
                opacity: 0;
            }
        }
        
        @keyframes modal-slide-down {
            to {
                transform: translateY(100%);
            }
        }
        
        .substitute-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .substitute-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .substitute-item:hover {
            background-color: #f5f5f5;
        }
        
        .exercise-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-planned {
            background-color: var(--accent);
        }
        
        .status-completed {
            background-color: var(--success);
        }
        
        .status-missed {
            background-color: var(--danger);
        }
        
        .status-modified {
            background-color: var(--warning);
        }
        
        .comparison-container {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .comparison-col {
            flex: 1;
            background-color: #f5f7fa;
            padding: 10px;
            border-radius: 5px;
        }
        
        .comparison-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary);
            text-align: center;
        }
        
        /* Workout options styling */
        .workout-options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .workout-option {
            flex: 1;
            min-width: 150px;
            border: 2px solid var(--light);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .workout-option h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .workout-option.selected {
            border-color: var(--primary);
            background-color: rgba(74, 111, 165, 0.1);
        }
        
        .workout-option:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .workout-option.rest-day {
            background-color: #f5f5f5;
        }
        
        .workout-option .exercise-count {
            font-size: 14px;
            color: var(--secondary);
        }
        
        .workout-option-footer {
            margin-top: 15px;
            text-align: center;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .col {
                flex: 100%;
                min-width: 100%;
            }
            
            .row {
                gap: 10px;
            }
            
            .comparison-container {
                flex-direction: column;
            }
            
            .workout-option {
                min-width: 100%;
            }
        }

        .weekly-sets-summary {
            background-color: #f5f5f5;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .weekly-sets-summary h3 {
            margin: 0;
            color: #333;
            font-size: 1.2em;
        }

        /* Add these styles after the existing .weekly-sets-summary styles */

        /* Workout Day Cards Grid */
        .day-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .day-card {
            background: var(--white);
            border: 1px solid var(--light);
            border-radius: 12px;
            padding: var(--spacing-md);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .day-card h3 {
            font-size: var(--font-size-lg);
            margin: 0;
            color: var(--primary);
        }

        .day-card div {
            font-size: var(--font-size-sm);
            color: var(--secondary);
        }

        .day-card.active {
            border-color: var(--primary);
            background-color: rgba(74, 111, 165, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Exercise List Styling */
        .exercise-list {
            display: grid;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .exercise-card {
            background: var(--white);
            border: 1px solid var(--light);
            border-radius: 12px;
            padding: var(--spacing-md);
            position: relative;
        }

        .exercise-card .actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .exercise-card button {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 6px;
            border: 1px solid var(--light);
            background: var(--white);
            color: var(--primary);
            cursor: pointer;
            font-size: var(--font-size-sm);
        }

        .exercise-card button:hover {
            background: var(--light);
        }

        .exercise-card .details {
            display: grid;
            gap: var(--spacing-xs);
            font-size: var(--font-size-sm);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .day-selector {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .day-card {
                padding: var(--spacing-md);
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .day-card h3 {
                font-size: var(--font-size-base);
                flex: 1;
            }

            .day-card div {
                white-space: nowrap;
                padding-left: var(--spacing-sm);
            }

            .exercise-card {
                padding: var(--spacing-sm);
            }

            .exercise-card .actions {
                position: relative;
                top: 0;
                right: 0;
                justify-content: flex-start;
                margin-bottom: var(--spacing-sm);
            }

            .exercise-card button {
                padding: var(--spacing-sm) var(--spacing-md);
                flex: 1;
                text-align: center;
                min-height: 44px; /* Better touch target */
            }

            .exercise-card .details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .day-card {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-xs);
            }

            .day-card div {
                padding-left: 0;
            }

            .exercise-card .actions {
                flex-direction: column;
            }
        }

        /* Add styles for the weekly sets summary to match the new design */
        .weekly-sets-summary {
            background: var(--white);
            border: 1px solid var(--light);
            border-radius: 12px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .weekly-sets-summary h3 {
            margin: 0;
            color: var(--primary);
            font-size: var(--font-size-lg);
        }

        /* Enhanced form styles */
        .form-group {
            margin-bottom: var(--element-spacing);
            position: relative;
        }

        label {
            display: block;
            margin-bottom: calc(var(--element-spacing) * 0.5);
            font-weight: 500;
            color: var(--dark);
        }

        input,
        select,
        textarea {
            width: 100%;
            min-height: var(--min-touch-target);
            padding: calc(var(--element-spacing) * 0.8) var(--element-spacing);
            border: 1px solid var(--light);
            border-radius: var(--card-border-radius);
            font-size: var(--font-size-base);
            background: var(--white);
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Specific input types optimization */
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"] {
            min-height: var(--min-touch-target);
            padding-right: calc(var(--element-spacing) * 2);
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Custom select styling */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--element-spacing) center;
            background-size: 1.2em;
            padding-right: calc(var(--element-spacing) * 3);
        }

        /* Focus states */
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }

        /* Error states */
        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: var(--danger);
        }

        .error-message {
            color: var(--danger);
            font-size: var(--font-size-sm);
            margin-top: calc(var(--element-spacing) * 0.5);
        }

        /* Enhanced button styles */
        button,
        .btn-primary,
        .btn-secondary,
        .btn-danger,
        .btn-success,
        .btn-warning {
            min-height: var(--min-touch-target);
            padding: calc(var(--element-spacing) * 0.8) var(--element-spacing);
            border: none;
            border-radius: var(--card-border-radius);
            font-weight: 500;
            font-size: var(--font-size-base);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--element-spacing);
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        /* Button loading state */
        button.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: button-loading 0.8s linear infinite;
        }

        @keyframes button-loading {
            to {
                transform: rotate(360deg);
            }
        }

        /* Mobile-specific form adjustments */
        @media (max-width: 768px) {
            .form-group {
                margin-bottom: calc(var(--element-spacing) * 1.5);
            }
            
            input,
            select,
            textarea {
                font-size: 16px; /* Prevent iOS zoom */
            }
            
            .form-actions {
                position: sticky;
                bottom: 0;
                background: var(--white);
                padding: var(--element-spacing);
                margin: calc(var(--element-spacing) * 2) calc(var(--element-spacing) * -1) calc(var(--element-spacing) * -1);
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                z-index: 1;
            }
            
            .form-actions button {
                width: 100%;
                margin-bottom: var(--element-spacing);
            }
            
            .form-actions button:last-child {
                margin-bottom: 0;
            }
            
            /* Optimize number input on mobile */
            .number-input-wrapper {
                display: flex;
                align-items: center;
                gap: calc(var(--element-spacing) * 0.5);
            }
            
            .number-input-wrapper button {
                flex: 0 0 var(--min-touch-target);
                height: var(--min-touch-target);
                padding: 0;
                background: var(--light);
                color: var(--dark);
                font-size: 1.2em;
            }
            
            .number-input-wrapper input {
                text-align: center;
            }
        }

        /* Add loading indicator for forms */
        .form-loading {
            position: relative;
        }

        .form-loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .form-loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: form-loading 0.8s linear infinite;
            z-index: 2;
        }

        @keyframes form-loading {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /* Enhanced Workout Tracking Styles */
        .workout-tracker {
            display: flex;
            flex-direction: column;
            gap: var(--element-spacing);
        }

        /* Exercise cards */
        .exercise-card {
            background: var(--white);
            border-radius: var(--card-border-radius);
            padding: calc(var(--element-spacing) * 1.5);
            margin-bottom: var(--element-spacing);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .exercise-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--element-spacing);
        }

        .exercise-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--dark);
            margin: 0;
        }

        .exercise-status {
            display: flex;
            align-items: center;
            gap: calc(var(--element-spacing) * 0.5);
            font-size: var(--font-size-sm);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-planned { background: var(--accent); }
        .status-completed { background: var(--success); }
        .status-skipped { background: var(--danger); }
        .status-modified { background: var(--warning); }

        .exercise-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--element-spacing);
            margin-bottom: var(--element-spacing);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: calc(var(--element-spacing) * 0.5);
        }

        .detail-label {
            font-size: var(--font-size-sm);
            color: var(--secondary);
        }

        .detail-value {
            font-size: var(--font-size-base);
            font-weight: 500;
        }

        .exercise-actions {
            display: flex;
            gap: var(--element-spacing);
            margin-top: calc(var(--element-spacing) * 1.5);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .exercise-card {
                padding: var(--element-spacing);
            }
            
            .exercise-details {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .exercise-actions {
                flex-direction: column;
            }
            
            .exercise-actions button {
                width: 100%;
            }
            
            /* Swipe actions */
            .exercise-card {
                touch-action: pan-y;
                transition: transform 0.3s ease;
            }
            
            .exercise-card.swiping {
                transition: none;
            }
            
            .swipe-actions {
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                display: flex;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }
            
            .swipe-action {
                width: var(--min-touch-target);
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: var(--font-size-lg);
            }
            
            .swipe-complete { background: var(--success); }
            .swipe-skip { background: var(--danger); }
            
            /* Progress indicators */
            .workout-progress {
                position: sticky;
                top: 0;
                background: var(--white);
                padding: var(--element-spacing);
                border-bottom: 1px solid var(--light);
                z-index: 2;
                margin: calc(var(--element-spacing) * -1);
                margin-bottom: var(--element-spacing);
            }
            
            .progress-bar {
                height: 4px;
                background: var(--light);
                border-radius: 2px;
                overflow: hidden;
                margin-top: calc(var(--element-spacing) * 0.5);
            }
            
            .progress-fill {
                height: 100%;
                background: var(--primary);
                transition: width 0.3s ease;
            }
            
            /* Enhanced touch feedback */
            .exercise-card:active {
                transform: scale(0.98);
            }
            
            /* Bottom action sheet */
            .action-sheet {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--white);
                padding: var(--element-spacing);
                padding-bottom: max(var(--element-spacing), env(safe-area-inset-bottom));
                border-radius: var(--card-border-radius) var(--card-border-radius) 0 0;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                z-index: 1000;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .action-sheet.visible {
                transform: translateY(0);
            }
            
            .action-sheet-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
                z-index: 999;
            }
            
            .action-sheet-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
        }

        /* Add these styles for the workout options */
        .workout-options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--element-spacing);
            margin: var(--element-spacing) 0;
        }

        .workout-option {
            background: var(--white);
            border: 2px solid var(--light);
            border-radius: var(--card-border-radius);
            padding: calc(var(--element-spacing) * 1.5);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: var(--element-spacing);
        }

        .workout-option.selected {
            border-color: var(--primary);
            background: rgba(74, 111, 165, 0.1);
        }

        .workout-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .workout-options-container {
                grid-template-columns: 1fr;
            }
            
            .workout-option {
                padding: var(--element-spacing);
            }
        }

        /* Hide default number input spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Remove any existing number-input-wrapper styles */
        .number-input-wrapper {
            display: none;
        }

        /* Add mobile bottom navigation styles */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding-bottom: env(safe-area-inset-bottom, 0px);
            z-index: 1000;
            height: var(--nav-height);
        }

        .mobile-nav-list {
            display: flex;
            justify-content: space-around;
            list-style: none;
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            color: var(--dark);
            text-decoration: none;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: color 0.2s ease;
            min-width: 64px;
            flex: 1;
            height: 100%;
        }

        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-nav-icon {
            width: 28px;
            height: 28px;
            margin-bottom: 4px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .mobile-nav-label {
            font-size: 12px;
            white-space: nowrap;
            text-align: center;
        }

        /* Adjust container padding for mobile bottom nav */
        @media (max-width: 768px) {
            .container {
                padding-bottom: calc(60px + env(safe-area-inset-bottom, 20px));
            }
            
            .tabs {
                display: none;
            }
            
            .mobile-nav {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FitTrack</h1>
        <button class="device-toggle" id="deviceToggle">Toggle Mobile Preview</button>
        
        <!-- Desktop tabs -->
        <div class="tabs">
            <div class="tab" data-tab="welcome">Welcome</div>
            <div class="tab" data-tab="daily-entry">Daily Entry</div>
            <div class="tab" data-tab="stats">Stats</div>
            <div class="tab" data-tab="graphs">Graphs</div>
            <div class="tab" data-tab="history">History</div>
            <div class="tab" data-tab="workout-plan">Workout Plan</div>
            <div class="tab" data-tab="workout-tracker">Workout Tracker</div>
        </div>

        <!-- Rest of the container content -->
        <!-- Edit Entry Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <h2>Edit Entry</h2>
                <form id="edit-form">
                    <input type="hidden" id="edit-entry-index">
                    
                    <div class="form-group">
                        <label for="edit-date">Date:</label>
                        <input type="date" id="edit-date" required>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="edit-weight-kg">Weight (kg):</label>
                                <input type="number" id="edit-weight-kg" min="20" max="300" step="0.1" placeholder="Enter weight in kg">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="edit-weight-lbs">Weight (lbs):</label>
                                <input type="number" id="edit-weight-lbs" min="40" max="660" step="0.1" placeholder="Enter weight in lbs">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Workouts:</label>
                        <div class="row">
                            <div class="col">
                                <select id="edit-workout-select">
                                    <option value="">Select workout</option>
                                    <option value="weights">Weights</option>
                                    <option value="martial arts">Martial Arts</option>
                                    <option value="biking">Biking</option>
                                    <option value="running">Running</option>
                                </select>
                            </div>
                            <div class="col">
                                <input type="text" id="edit-custom-workout" placeholder="Or add custom workout">
                            </div>
                        </div>
                        <button type="button" id="edit-add-workout" style="margin-top: 10px;">Add Workout</button>
                        <div id="edit-selected-workouts" class="workout-list"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="edit-calories-intake">Calories Intake:</label>
                                <input type="number" id="edit-calories-intake" min="0" max="10000" placeholder="Calories consumed">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="edit-calories-burned">Calories Burned:</label>
                                <input type="number" id="edit-calories-burned" min="0" max="10000" placeholder="Calories burned">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" id="save-edit">Save Changes</button>
                        <button type="button" id="cancel-edit" class="btn-danger">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Substitute Exercise Modal -->
        <div id="substituteModal" class="modal">
            <div class="modal-content">
                <h2>Substitute Exercise</h2>
                <div class="form-group">
                    <label for="substitute-search">Search Exercise:</label>
                    <input type="text" id="substitute-search" placeholder="Type to search exercises">
                </div>
                
                <div class="substitute-list" id="substitute-exercises">
                    <!-- Will be populated with JavaScript -->
                </div>
                
                <div class="form-group">
                    <label for="custom-substitute">Or Add Custom Exercise:</label>
                    <input type="text" id="custom-substitute" placeholder="Enter exercise name">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" id="confirm-substitute">Substitute</button>
                    <button type="button" id="cancel-substitute" class="btn-danger">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Exercise Form Modal -->
        <div id="exerciseFormModal" class="modal">
            <div class="modal-content">
                <h2 id="exercise-form-title">Add Exercise</h2>
                <form id="exercise-form">
                    <input type="hidden" id="edit-exercise-index" value="-1">
                    <input type="hidden" id="edit-day-index" value="-1">
                    
                    <div class="form-group">
                        <label for="exercise-name">Exercise Name:</label>
                        <input type="text" id="exercise-name" required placeholder="e.g. Bench Press">
                    </div>
                    
                    <div class="form-group">
                        <label for="exercise-category">Category:</label>
                        <select id="exercise-category" required>
                            <option value="">Select category</option>
                            <option value="chest">Chest</option>
                            <option value="back">Back</option>
                            <option value="legs">Legs</option>
                            <option value="shoulders">Shoulders</option>
                            <option value="arms">Arms</option>
                            <option value="core">Core</option>
                            <option value="cardio">Cardio</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="exercise-sets">Sets:</label>
                                <input type="number" id="exercise-sets" min="1" max="20" required placeholder="e.g. 3">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="exercise-reps">Target Reps:</label>
                                <input type="number" id="exercise-reps" min="1" max="100" required placeholder="e.g. 12">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="exercise-weight">Weight (kg):</label>
                                <input type="number" id="exercise-weight" min="0" max="1000" step="0.5" required placeholder="e.g. 60">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="exercise-rest">Rest (seconds):</label>
                                <input type="number" id="exercise-rest" min="0" max="600" step="5" placeholder="e.g. 90">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="exercise-notes">Notes:</label>
                        <textarea id="exercise-notes" rows="3" placeholder="Additional notes or instructions"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" id="save-exercise">Save Exercise</button>
                        <button type="button" id="cancel-exercise-form" class="btn-danger">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Log Exercise Modal -->
        <div id="logExerciseModal" class="modal">
            <div class="modal-content">
                <h2>Log Exercise</h2>
                <form id="log-exercise-form">
                    <input type="hidden" id="log-exercise-id">
                    <input type="hidden" id="log-day-index">
                    
                    <div class="exercise-info" id="log-exercise-info">
                        <!-- Exercise info will be displayed here -->
                    </div>
                    
                    <div id="comparison-container" class="comparison-container">
                        <div class="comparison-col">
                            <div class="comparison-title">Planned</div>
                            <div id="planned-details">
                                <!-- Planned details will go here -->
                            </div>
                        </div>
                        <div class="comparison-col">
                            <div class="comparison-title">Actual</div>
                            <div id="actual-form">
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="actual-sets">Sets:</label>
                                            <input type="number" id="actual-sets" min="1" max="20" required>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="actual-reps">Reps:</label>
                                            <input type="number" id="actual-reps" min="1" max="100" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="actual-weight">Weight (kg):</label>
                                            <input type="number" id="actual-weight" min="0" max="1000" step="0.5" required>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label for="actual-difficulty">Difficulty:</label>
                                            <select id="actual-difficulty" required>
                                                <option value="easy">Too Easy</option>
                                                <option value="moderate" selected>Just Right</option>
                                                <option value="hard">Too Hard</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="actual-notes">Notes:</label>
                                    <textarea id="actual-notes" rows="2" placeholder="How did it feel? Any issues?"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" id="save-log" class="btn-success">Save</button>
                        <button type="button" id="substitute-exercise" class="btn-warning">Substitute</button>
                        <button type="button" id="skip-exercise" class="btn-danger">Skip</button>
                        <button type="button" id="cancel-log" class="btn-danger">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="welcome" class="tab-content">
            <h2>Welcome to FitTrack</h2>
            
            <div class="highlights-container">
                <div class="highlight-card">
                    <h3>Today's Overview</h3>
                    <div id="welcome-today-stats">
                        <div class="stats-item">
                            <span>Today's Weight:</span>
                            <span id="welcome-weight">--</span>
                        </div>
                        <div class="stats-item">
                            <span>Net Calories:</span>
                            <span id="welcome-calories">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="highlight-card">
                    <h3>Progress Summary</h3>
                    <div id="welcome-progress">
                        <div class="stats-item">
                            <span>Weight Change (30 days):</span>
                            <span id="welcome-weight-change">--</span>
                        </div>
                        <div class="stats-item">
                            <span>Workouts Completed:</span>
                            <span id="welcome-workouts">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="highlight-card">
                    <h3>Today's Workout</h3>
                    <div id="welcome-workout">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="highlight-card">
                    <h3>Quick Actions</h3>
                    <div class="quick-actions">
                        <button onclick="switchTab('daily-entry')" class="btn-primary">Log Today's Entry</button>
                        <button onclick="switchTab('workout-tracker')" class="btn-primary">Track Workout</button>
                        <button onclick="switchTab('stats')" class="btn-primary">View Stats</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="daily-entry" class="tab-content">
            <h2>Add Today's Entry</h2>
            <form id="entry-form">
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="date">Date:</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="weight-kg">Weight (kg):</label>
                            <input type="number" id="weight-kg" min="20" max="300" step="0.1" placeholder="Enter weight in kg">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="weight-lbs">Weight (lbs):</label>
                            <input type="number" id="weight-lbs" min="40" max="660" step="0.1" placeholder="Enter weight in lbs">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Workouts:</label>
                    <div class="row">
                        <div class="col">
                            <select id="workout-select">
                                <option value="">Select workout</option>
                                <option value="weights">Weights</option>
                                <option value="martial arts">Martial Arts</option>
                                <option value="biking">Biking</option>
                                <option value="running">Running</option>
                            </select>
                        </div>
                        <div class="col">
                            <input type="text" id="custom-workout" placeholder="Or add custom workout">
                        </div>
                    </div>
                    <button type="button" id="add-workout" class="btn-primary" style="margin-top: 10px;">Add Workout</button>
                    <div id="selected-workouts" class="workout-list"></div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="calories-intake">Calories Intake:</label>
                            <input type="number" id="calories-intake" min="0" max="10000" placeholder="Calories consumed">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="calories-burned">Calories Burned:</label>
                            <input type="number" id="calories-burned" min="0" max="10000" placeholder="Calories burned">
                        </div>
                    </div>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" id="save-entry" class="btn-success">Save Entry</button>
                    <button type="button" id="reset-form" class="btn-danger">Reset Form</button>
                </div>
            </form>
        </div>
        
        <div id="stats" class="tab-content">
            <h2>Stats & Projections</h2>
            
            <section>
                <div class="stats-card">
                    <h3>Weight Statistics</h3>
                    <div class="stats-item">
                        <span>Current Weight:</span>
                        <span id="current-weight">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Starting Weight:</span>
                        <span id="starting-weight">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Total Change:</span>
                        <span id="total-change">--</span>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h3>Weight Projections</h3>
                    <div class="stats-item">
                        <span>7 Days:</span>
                        <span id="projection-7">--</span>
                    </div>
                    <div class="stats-item">
                        <span>30 Days:</span>
                        <span id="projection-30">--</span>
                    </div>
                    <div class="stats-item">
                        <span>60 Days:</span>
                        <span id="projection-60">--</span>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h3>Calorie Summary</h3>
                    <div class="stats-item">
                        <span>Today's Net Calories:</span>
                        <span id="today-net-calories">--</span>
                    </div>
                    <div class="stats-item">
                        <span>This Week's Net Calories:</span>
                        <span id="week-net-calories">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Average Daily Deficit/Surplus (All Time):</span>
                        <span id="avg-daily-calories-all-time">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Average Daily Deficit/Surplus (Last 7 Days):</span>
                        <span id="avg-daily-calories-week">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Theoretical Weight Change (Calories):</span>
                        <span id="theoretical-weight-change">--</span>
                    </div>
                </div>
                
                <div class="stats-card">
                    <h3>Workout Statistics</h3>
                    <div class="stats-item">
                        <span>Completed Workouts:</span>
                        <span id="completed-workouts">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Completion Rate:</span>
                        <span id="completion-rate">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Total Volume (Last Week):</span>
                        <span id="total-volume">--</span>
                    </div>
                </div>
            </section>
        </div>
        
        <div id="graphs" class="tab-content">
            <h2>Weight Progression</h2>
            <div class="graph-controls">
                <div class="btn-group" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="graph-btn active" data-range="week">Week</button>
                    <button class="graph-btn" data-range="month">Month</button>
                    <button class="graph-btn" data-range="3month">3 Months</button>
                    <button class="graph-btn" data-range="year">Year</button>
                    <button class="graph-btn" data-range="all">All Time</button>
                </div>
            </div>
            <div class="graph-container" style="height: 400px; position: relative;">
                <canvas id="weightChart"></canvas>
            </div>
            <div class="graph-info" style="margin-top: 20px;">
                <div id="graph-summary" class="stats-card">
                    <h3>Summary for Selected Period</h3>
                    <div class="stats-item">
                        <span>Starting Weight:</span>
                        <span id="graph-starting-weight">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Ending Weight:</span>
                        <span id="graph-ending-weight">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Change:</span>
                        <span id="graph-weight-change">--</span>
                    </div>
                    <div class="stats-item">
                        <span>Average Daily Change:</span>
                        <span id="graph-daily-change">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="history" class="tab-content">
            <h2>History</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Weight (kg/lbs)</th>
                        <th>Workouts</th>
                        <th>Net Calories</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="history-data">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="export-data" style="background-color: var(--secondary);">Export Data (JSON)</button>
                <label for="import-file" style="background-color: var(--accent); color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; display: inline-block;">
                    Import Data (JSON)
                </label>
                <input type="file" id="import-file" accept=".json" style="display: none;">
                <button id="clear-data" class="btn-danger">Clear All Data</button>
            </div>
        </div>
        
        <!-- Workout Plan Tab -->
        <div id="workout-plan" class="tab-content">
            <h2>Workout Mesocycle Planner</h2>
            
            <div class="card-notice">
                Configure your workout plan for Week 1, and the system will automatically create a progressive overload plan for future weeks.
            </div>
            
            <div class="form-group">
                <label for="mesocycle-name">Mesocycle Name:</label>
                <input type="text" id="mesocycle-name" placeholder="e.g. Summer Hypertrophy Block">
            </div>
            
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="mesocycle-weeks">Number of Weeks:</label>
                        <input type="number" id="mesocycle-weeks" min="2" max="16" value="6">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="overload-strategy">Progression Strategy:</label>
                        <select id="overload-strategy">
                            <option value="weight">Increase Weight</option>
                            <option value="reps">Increase Reps</option>
                            <option value="sets">Increase Sets</option>
                            <option value="mixed" selected>Mixed (Weight, Reps, Sets)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="toggle-btn">
                <button type="button" id="config-mode" class="active">Configure</button>
                <button type="button" id="preview-mode">Preview</button>
            </div>
            
            <div id="config-section">
                <div class="form-group">
                    <label>Workout Days:</label>
                    <div class="day-selector" id="day-selector">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <button type="button" id="add-day">Add New Workout Day</button>
                </div>
                
                <div id="day-exercises">
                    <div class="card-notice" id="no-day-selected" style="display: none;">
                        Please select or add a workout day to configure exercises.
                    </div>
                    
                    <div id="exercise-list">
                        <!-- Exercises will be listed here -->
                    </div>
                    
                    <button type="button" id="add-exercise" style="margin-top: 15px; display: none;">Add Exercise</button>
                </div>
            </div>
            
            <div id="preview-section" style="display: none;">
                <h3>Mesocycle Progression Preview</h3>
                <div class="mesocycle-weeks" id="mesocycle-preview">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" id="save-mesocycle">Save Mesocycle</button>
                <button type="button" id="export-mesocycle" style="background-color: var(--secondary);">Export Mesocycle</button>
                <label for="import-mesocycle-file" style="background-color: var(--accent); color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; display: inline-block;">
                    Import Mesocycle
                </label>
                <input type="file" id="import-mesocycle-file" accept=".json" style="display: none;">
                <button type="button" id="reset-mesocycle" class="btn-danger">Reset Plan</button>
            </div>
        </div>
        
        <!-- Workout Tracker Tab -->
        <div id="workout-tracker" class="tab-content">
            <h2>Workout Tracker</h2>
            
            <div class="form-group">
                <label for="tracker-date">Select Date:</label>
                <input type="date" id="tracker-date">
            </div>
            
            <div id="workout-selector-card" class="stats-card">
                <h3>Select Workout for <span id="workout-date-display"></span></h3>
                
                <div class="workout-options-container" id="workout-options-container">
                    <!-- Workout options will be populated dynamically -->
                </div>
                
                <div id="workout-status-display" style="margin-top: 15px;"></div>
                
                <div id="no-workouts-notice" style="margin-top: 20px; display: none;">
                    <div class="card-notice">
                        <p>You haven't created any workout days yet.</p>
                        <button type="button" id="go-to-plan-btn" class="btn-primary" style="margin-top: 10px;">Go to Workout Plan</button>
                    </div>
                </div>
            </div>
            
            <div id="planned-workout-card" class="stats-card" style="display: none;">
                <h3>Workout for <span id="workout-date-display-2"></span></h3>
                <div id="workout-day-name"></div>
                <div id="workout-completion-status"></div>
                <button type="button" id="change-workout-btn" class="btn-primary" style="margin-top: 10px;">Change Workout</button>
            </div>
            
            <div id="no-workout-card" class="card-notice" style="display: none;">
                <h3>Rest Day</h3>
                <p>You've marked this as a rest day. No workout planned.</p>
                <button type="button" id="change-to-workout-btn" class="btn-primary">Change to Workout Day</button>
            </div>
            
            <div id="exercise-tracker-list">
                <!-- Exercise lists for tracking will go here -->
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" id="mark-completed" class="btn-success" style="display: none;">Mark All Completed</button>
                <button type="button" id="skip-workout" class="btn-danger" style="display: none;">Skip This Workout</button>
            </div>
        </div>
    </div>

    <!-- Mobile navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-list">
            <div class="mobile-nav-item" data-tab="welcome">
                <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                    <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
                </svg>
                <span class="mobile-nav-label">Home</span>
            </div>
            <div class="mobile-nav-item" data-tab="daily-entry">
                <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                    <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                </svg>
                <span class="mobile-nav-label">Log</span>
            </div>
            <div class="mobile-nav-item" data-tab="stats">
                <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                    <path d="M16,11.78L20.24,4.45L21.97,5.45L16.74,14.5L10.23,10.75L5.46,19H22V21H2V3H4V17.54L9.5,8L16,11.78Z" />
                </svg>
                <span class="mobile-nav-label">Stats</span>
            </div>
            <div class="mobile-nav-item" data-tab="workout-tracker">
                <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                    <path d="M20.57,14.86L22,13.43L20.57,12L17,15.57L8.43,7L12,3.43L10.57,2L9.14,3.43L7.71,2L5.57,4.14L4.14,2.71L2.71,4.14L4.14,5.57L2,7.71L3.43,9.14L2,10.57L3.43,12L7,8.43L15.57,17L12,20.57L13.43,22L14.86,20.57L16.29,22L18.43,19.86L19.86,21.29L21.29,19.86L19.86,18.43L22,16.29L20.57,14.86Z" />
                </svg>
                <span class="mobile-nav-label">Workout</span>
            </div>
            <div class="mobile-nav-item" data-tab="more">
                <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                    <path d="M16,12A2,2 0 0,1 18,10A2,2 0 0,1 20,12A2,2 0 0,1 18,14A2,2 0 0,1 16,12M10,12A2,2 0 0,1 12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12M4,12A2,2 0 0,1 6,10A2,2 0 0,1 8,12A2,2 0 0,1 6,14A2,2 0 0,1 4,12Z" />
                </svg>
                <span class="mobile-nav-label">More</span>
            </div>
        </div>
    </nav>

    <script>
        // Constants
        const KG_TO_LBS = 2.20462;
        const LBS_TO_KG = 0.453592;
        const CALORIES_PER_KG = 7700; // Approx calories in 1kg of body fat
        
        // Common exercise database for substitutions
        const exerciseDatabase = [
            { name: "Bench Press", category: "chest" },
            { name: "Incline Bench Press", category: "chest" },
            { name: "Decline Bench Press", category: "chest" },
            { name: "Dumbbell Press", category: "chest" },
            { name: "Dumbbell Fly", category: "chest" },
            { name: "Push-Up", category: "chest" },
            { name: "Cable Fly", category: "chest" },
            { name: "Pec Deck", category: "chest" },
            { name: "Deadlift", category: "back" },
            { name: "Pull-Up", category: "back" },
            { name: "Lat Pulldown", category: "back" },
            { name: "Bent Over Row", category: "back" },
            { name: "T-Bar Row", category: "back" },
            { name: "Seated Cable Row", category: "back" },
            { name: "Face Pull", category: "back" },
            { name: "Squat", category: "legs" },
            { name: "Leg Press", category: "legs" },
            { name: "Leg Extension", category: "legs" },
            { name: "Leg Curl", category: "legs" },
            { name: "Lunge", category: "legs" },
            { name: "Romanian Deadlift", category: "legs" },
            { name: "Calf Raise", category: "legs" },
            { name: "Military Press", category: "shoulders" },
            { name: "Lateral Raise", category: "shoulders" },
            { name: "Front Raise", category: "shoulders" },
            { name: "Rear Delt Fly", category: "shoulders" },
            { name: "Upright Row", category: "shoulders" },
            { name: "Shrug", category: "shoulders" },
            { name: "Bicep Curl", category: "arms" },
            { name: "Hammer Curl", category: "arms" },
            { name: "Tricep Extension", category: "arms" },
            { name: "Tricep Pushdown", category: "arms" },
            { name: "Skull Crusher", category: "arms" },
            { name: "Dip", category: "arms" },
            { name: "Sit-Up", category: "core" },
            { name: "Crunch", category: "core" },
            { name: "Plank", category: "core" },
            { name: "Russian Twist", category: "core" },
            { name: "Leg Raise", category: "core" },
            { name: "Running", category: "cardio" },
            { name: "Cycling", category: "cardio" },
            { name: "Rowing", category: "cardio" },
            { name: "Stair Climber", category: "cardio" },
            { name: "Jumping Rope", category: "cardio" }
        ];
        
        // DOM Elements
        const dateInput = document.getElementById('date');
        const weightKgInput = document.getElementById('weight-kg');
        const weightLbsInput = document.getElementById('weight-lbs');
        const workoutSelect = document.getElementById('workout-select');
        const customWorkoutInput = document.getElementById('custom-workout');
        const addWorkoutBtn = document.getElementById('add-workout');
        const selectedWorkoutsContainer = document.getElementById('selected-workouts');
        const caloriesIntakeInput = document.getElementById('calories-intake');
        const caloriesBurnedInput = document.getElementById('calories-burned');
        const entryForm = document.getElementById('entry-form');
        const resetFormBtn = document.getElementById('reset-form');
        const clearDataBtn = document.getElementById('clear-data');
        const exportDataBtn = document.getElementById('export-data');
        const importFileInput = document.getElementById('import-file');
        const historyDataTable = document.getElementById('history-data');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Edit modal elements
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('edit-form');
        const editEntryIndexInput = document.getElementById('edit-entry-index');
        const editDateInput = document.getElementById('edit-date');
        const editWeightKgInput = document.getElementById('edit-weight-kg');
        const editWeightLbsInput = document.getElementById('edit-weight-lbs');
        const editWorkoutSelect = document.getElementById('edit-workout-select');
        const editCustomWorkoutInput = document.getElementById('edit-custom-workout');
        const editAddWorkoutBtn = document.getElementById('edit-add-workout');
        const editSelectedWorkoutsContainer = document.getElementById('edit-selected-workouts');
        const editCaloriesIntakeInput = document.getElementById('edit-calories-intake');
        const editCaloriesBurnedInput = document.getElementById('edit-calories-burned');
        const cancelEditBtn = document.getElementById('cancel-edit');
        
        // Stats elements
        const currentWeightEl = document.getElementById('current-weight');
        const startingWeightEl = document.getElementById('starting-weight');
        const totalChangeEl = document.getElementById('total-change');
        const projection7El = document.getElementById('projection-7');
        const projection30El = document.getElementById('projection-30');
        const projection60El = document.getElementById('projection-60');
        const todayNetCaloriesEl = document.getElementById('today-net-calories');
        const weekNetCaloriesEl = document.getElementById('week-net-calories');
        const theoreticalWeightChangeEl = document.getElementById('theoretical-weight-change');
        
        // Workout Plan elements
        const mesocycleNameInput = document.getElementById('mesocycle-name');
        const mesocycleWeeksInput = document.getElementById('mesocycle-weeks');
        const overloadStrategySelect = document.getElementById('overload-strategy');
        const daySelector = document.getElementById('day-selector');
        const exerciseList = document.getElementById('exercise-list');
        const addDayBtn = document.getElementById('add-day');
        const addExerciseBtn = document.getElementById('add-exercise');
        const saveMesocycleBtn = document.getElementById('save-mesocycle');
        const exportMesocycleBtn = document.getElementById('export-mesocycle');
        const importMesocycleFileInput = document.getElementById('import-mesocycle-file');
        const resetMesocycleBtn = document.getElementById('reset-mesocycle');
        const configModeBtn = document.getElementById('config-mode');
        const previewModeBtn = document.getElementById('preview-mode');
        const configSection = document.getElementById('config-section');
        const previewSection = document.getElementById('preview-section');
        const mesocyclePreview = document.getElementById('mesocycle-preview');
        const noDaySelected = document.getElementById('no-day-selected');
        
        // Exercise Form elements
        const exerciseFormModal = document.getElementById('exerciseFormModal');
        const exerciseForm = document.getElementById('exercise-form');
        const exerciseFormTitle = document.getElementById('exercise-form-title');
        const exerciseNameInput = document.getElementById('exercise-name');
        const exerciseCategorySelect = document.getElementById('exercise-category');
        const exerciseSetsInput = document.getElementById('exercise-sets');
        const exerciseRepsInput = document.getElementById('exercise-reps');
        const exerciseWeightInput = document.getElementById('exercise-weight');
        const exerciseRestInput = document.getElementById('exercise-rest');
        const exerciseNotesInput = document.getElementById('exercise-notes');
        const saveExerciseBtn = document.getElementById('save-exercise');
        const cancelExerciseFormBtn = document.getElementById('cancel-exercise-form');
        const editExerciseIndexInput = document.getElementById('edit-exercise-index');
        const editDayIndexInput = document.getElementById('edit-day-index');
        
        // Workout Tracker elements
        const trackerDateInput = document.getElementById('tracker-date');
        const workoutSelectorCard = document.getElementById('workout-selector-card');
        const workoutOptionsContainer = document.getElementById('workout-options-container');
        const workoutStatusDisplay = document.getElementById('workout-status-display');
        const noWorkoutsNotice = document.getElementById('no-workouts-notice');
        const goToPlanBtn = document.getElementById('go-to-plan-btn');
        const plannedWorkoutCard = document.getElementById('planned-workout-card');
        const noWorkoutCard = document.getElementById('no-workout-card');
        const workoutDateDisplay = document.getElementById('workout-date-display');
        const workoutDateDisplay2 = document.getElementById('workout-date-display-2');
        const workoutDayName = document.getElementById('workout-day-name');
        const workoutCompletionStatus = document.getElementById('workout-completion-status');
        const exerciseTrackerList = document.getElementById('exercise-tracker-list');
        const markCompletedBtn = document.getElementById('mark-completed');
        const skipWorkoutBtn = document.getElementById('skip-workout');
        const changeToWorkoutBtn = document.getElementById('change-to-workout-btn');
        const changeWorkoutBtn = document.getElementById('change-workout-btn');
        
        // Log Exercise elements
        const logExerciseModal = document.getElementById('logExerciseModal');
        const logExerciseForm = document.getElementById('log-exercise-form');
        const logExerciseInfo = document.getElementById('log-exercise-info');
        const logExerciseIdInput = document.getElementById('log-exercise-id');
        const logDayIndexInput = document.getElementById('log-day-index');
        const plannedDetails = document.getElementById('planned-details');
        const actualSetsInput = document.getElementById('actual-sets');
        const actualRepsInput = document.getElementById('actual-reps');
        const actualWeightInput = document.getElementById('actual-weight');
        const actualDifficultySelect = document.getElementById('actual-difficulty');
        const actualNotesInput = document.getElementById('actual-notes');
        const saveLogBtn = document.getElementById('save-log');
        const substituteExerciseBtn = document.getElementById('substitute-exercise');
        const skipExerciseBtn = document.getElementById('skip-exercise');
        const cancelLogBtn = document.getElementById('cancel-log');
        
        // Substitute Exercise elements
        const substituteModal = document.getElementById('substituteModal');
        const substituteSearchInput = document.getElementById('substitute-search');
        const substituteExercises = document.getElementById('substitute-exercises');
        const customSubstituteInput = document.getElementById('custom-substitute');
        const confirmSubstituteBtn = document.getElementById('confirm-substitute');
        const cancelSubstituteBtn = document.getElementById('cancel-substitute');
        
        // Data storage
        let entries = JSON.parse(localStorage.getItem('fitnessEntries')) || [];
        let selectedWorkouts = [];
        let editSelectedWorkouts = [];
        
        // Workout plan data
        let mesocycle = JSON.parse(localStorage.getItem('mesocycle')) || {
            name: "My Workout Plan",
            weeks: 6,
            strategy: "mixed",
            days: []
        };
        
        // Workout tracking data
        let workoutLogs = JSON.parse(localStorage.getItem('workoutLogs')) || {};
        
        // Current state variables
        let currentDayIndex = -1;
        let currentExerciseIndex = -1;
        let currentSubstituteTarget = null;
        
        // Set today's date as default
        function setTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            trackerDateInput.value = `${year}-${month}-${day}`;
        }
        
        // Weight conversion functions
        function kgToLbs(kg) {
            return kg * KG_TO_LBS;
        }
        
        function lbsToKg(lbs) {
            return lbs * LBS_TO_KG;
        }
        
        // Event Listeners for weight conversions
        weightKgInput.addEventListener('input', function() {
            if (this.value) {
                weightLbsInput.value = (kgToLbs(parseFloat(this.value))).toFixed(1);
            } else {
                weightLbsInput.value = '';
            }
        });
        
        weightLbsInput.addEventListener('input', function() {
            if (this.value) {
                weightKgInput.value = (lbsToKg(parseFloat(this.value))).toFixed(1);
            } else {
                weightKgInput.value = '';
            }
        });
        
        // Edit form weight conversion
        editWeightKgInput.addEventListener('input', function() {
            if (this.value) {
                editWeightLbsInput.value = (kgToLbs(parseFloat(this.value))).toFixed(1);
            } else {
                editWeightLbsInput.value = '';
            }
        });
        
        editWeightLbsInput.addEventListener('input', function() {
            if (this.value) {
                editWeightKgInput.value = (lbsToKg(parseFloat(this.value))).toFixed(1);
            } else {
                editWeightKgInput.value = '';
            }
        });
        
        // Add workout to the list
        addWorkoutBtn.addEventListener('click', function() {
            let workout = '';
            
            if (workoutSelect.value) {
                workout = workoutSelect.value;
            } else if (customWorkoutInput.value.trim()) {
                workout = customWorkoutInput.value.trim();
            }
            
            if (workout && !selectedWorkouts.includes(workout)) {
                selectedWorkouts.push(workout);
                renderSelectedWorkouts();
                
                // Reset inputs
                workoutSelect.value = '';
                customWorkoutInput.value = '';
            }
        });
        
        // Render selected workouts
        function renderSelectedWorkouts() {
            selectedWorkoutsContainer.innerHTML = '';
            
            selectedWorkouts.forEach(workout => {
                const workoutItem = document.createElement('div');
                workoutItem.className = 'workout-item';
                
                workoutItem.innerHTML = `
                    <span>${workout}</span>
                    <button type="button" data-workout="${workout}">&times;</button>
                `;
                
                selectedWorkoutsContainer.appendChild(workoutItem);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.workout-item button').forEach(button => {
                button.addEventListener('click', function() {
                    const workoutToRemove = this.getAttribute('data-workout');
                    selectedWorkouts = selectedWorkouts.filter(w => w !== workoutToRemove);
                    renderSelectedWorkouts();
                });
            });
        }
        
        // Save entry
        entryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const date = dateInput.value;
            const weightKg = parseFloat(weightKgInput.value) || null;
            const caloriesIntake = parseInt(caloriesIntakeInput.value) || 0;
            const caloriesBurned = parseInt(caloriesBurnedInput.value) || 0;
            const netCalories = caloriesIntake - caloriesBurned;
            
            // Check if entry for this date already exists
            const existingEntryIndex = entries.findIndex(entry => entry.date === date);
            
            const entryData = {
                date,
                weightKg,
                workouts: [...selectedWorkouts],
                caloriesIntake,
                caloriesBurned,
                netCalories
            };
            
            if (existingEntryIndex !== -1) {
                // Update existing entry
                entries[existingEntryIndex] = entryData;
            } else {
                // Add new entry
                entries.push(entryData);
            }
            
            // Sort entries by date (newest first)
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Save to localStorage
            localStorage.setItem('fitnessEntries', JSON.stringify(entries));
            
            // Update UI
            renderHistory();
            updateStats();
            updateWelcomeTab();
            resetForm();
            
            // Switch to stats tab
            switchTab('stats');
        });
        
        // Reset form
        resetFormBtn.addEventListener('click', resetForm);
        
        function resetForm() {
            setTodayDate();
            weightKgInput.value = '';
            weightLbsInput.value = '';
            workoutSelect.value = '';
            customWorkoutInput.value = '';
            caloriesIntakeInput.value = '';
            caloriesBurnedInput.value = '';
            selectedWorkouts = [];
            renderSelectedWorkouts();
        }
        
        // Clear all data
        clearDataBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete all your data? This cannot be undone.')) {
                entries = [];
                localStorage.removeItem('fitnessEntries');
                renderHistory();
                updateStats();
                alert('All data has been cleared.');
            }
        });
        
        // Render history table
        function renderHistory() {
            historyDataTable.innerHTML = '';
            
            entries.forEach(entry => {
                const weightLbs = entry.weightKg ? (entry.weightKg * KG_TO_LBS).toFixed(1) : '--';
                const weightKg = entry.weightKg ? entry.weightKg.toFixed(1) : '--';
                const row = document.createElement('tr');
                
                const formattedDate = new Date(entry.date).toLocaleDateString();
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${weightKg} kg / ${weightLbs} lbs</td>
                    <td>${entry.workouts.join(', ') || 'None'}</td>
                    <td class="${entry.netCalories > 0 ? 'negative' : 'positive'}">${entry.netCalories}</td>
                <td>
                        <button class="edit-entry" data-index="${entries.indexOf(entry)}">Edit</button>
                        <button class="delete-entry" data-date="${entry.date}">Delete</button>
                    </td>
                `;
                
                historyDataTable.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-entry').forEach(button => {
                button.addEventListener('click', function() {
                    const dateToRemove = this.getAttribute('data-date');
                    entries = entries.filter(entry => entry.date !== dateToRemove);
                    
                    localStorage.setItem('fitnessEntries', JSON.stringify(entries));
                    renderHistory();
                    updateStats();
                });
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-entry').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    openEditModal(index);
                });
            });
        }
        
        // Chart variables
        let weightChart = null;
        const graphBtns = document.querySelectorAll('.graph-btn');
        const graphStartingWeightEl = document.getElementById('graph-starting-weight');
        const graphEndingWeightEl = document.getElementById('graph-ending-weight');
        const graphWeightChangeEl = document.getElementById('graph-weight-change');
        const graphDailyChangeEl = document.getElementById('graph-daily-change');
        
        // Update stats and projections
        function updateStats() {
            if (entries.length === 0) {
                resetStats();
                return;
            }
            
            // Get latest weight entry
            const latestWeightEntry = entries.find(entry => entry.weightKg !== null);
            
            if (!latestWeightEntry) {
                resetStats();
                return;
            }
            
            // Weight stats
            const currentWeightKg = latestWeightEntry.weightKg;
            const currentWeightLbs = kgToLbs(currentWeightKg);
            
            // Starting weight (first entry with weight)
            const entriesCopy = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstWeightEntry = entriesCopy.find(entry => entry.weightKg !== null);
            const startingWeightKg = firstWeightEntry.weightKg;
            const startingWeightLbs = kgToLbs(startingWeightKg);
            
            // Total change
            const totalChangeKg = currentWeightKg - startingWeightKg;
            const totalChangeLbs = kgToLbs(Math.abs(totalChangeKg));
            const changeDirection = totalChangeKg < 0 ? 'loss' : 'gain';
            
            // Update weight stats in UI
            currentWeightEl.textContent = `${currentWeightKg.toFixed(1)} kg / ${currentWeightLbs.toFixed(1)} lbs`;
            startingWeightEl.textContent = `${startingWeightKg.toFixed(1)} kg / ${startingWeightLbs.toFixed(1)} lbs`;
            totalChangeEl.textContent = `${Math.abs(totalChangeKg).toFixed(1)} kg / ${totalChangeLbs.toFixed(1)} lbs ${changeDirection}`;
            totalChangeEl.className = changeDirection === 'loss' ? 'positive' : 'negative';
            
            // Calculate projections
            calculateProjections(currentWeightKg);
            
            // Calculate calorie stats
            calculateCalorieStats();
            
            // Update workout stats
            updateWorkoutStats();
            
            // Update weight chart
            updateWeightChart('week');
        }
        
        // Calculate weight projections
        function calculateProjections(currentWeightKg) {
            // Get weight history sorted by date
            const weightHistory = entries
                .filter(entry => entry.weightKg !== null)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (weightHistory.length < 2) {
                // Not enough data for trend projection
                projection7El.textContent = '--';
                projection30El.textContent = '--';
                projection60El.textContent = '--';
                return;
            }
            
            // Calculate average daily weight change
            let totalDailyChange = 0;
            let dataPoints = 0;
            
            for (let i = 1; i < weightHistory.length; i++) {
                const daysBetween = daysDiff(new Date(weightHistory[i-1].date), new Date(weightHistory[i].date));
                if (daysBetween > 0) {
                    const dailyChange = (weightHistory[i].weightKg - weightHistory[i-1].weightKg) / daysBetween;
                    totalDailyChange += dailyChange;
                    dataPoints++;
                }
            }
            
            // Calculate average daily change (use a minimum of 30 days of data or all available)
            const avgDailyChange = dataPoints > 0 ? totalDailyChange / dataPoints : 0;
            
            // Project future weights
            const proj7kg = currentWeightKg + (avgDailyChange * 7);
            const proj30kg = currentWeightKg + (avgDailyChange * 30);
            const proj60kg = currentWeightKg + (avgDailyChange * 60);
            
            // Update UI
            projection7El.textContent = `${proj7kg.toFixed(1)} kg / ${kgToLbs(proj7kg).toFixed(1)} lbs`;
            projection30El.textContent = `${proj30kg.toFixed(1)} kg / ${kgToLbs(proj30kg).toFixed(1)} lbs`;
            projection60El.textContent = `${proj60kg.toFixed(1)} kg / ${kgToLbs(proj60kg).toFixed(1)} lbs`;
        }
        
        // Calculate calorie stats
        function calculateCalorieStats() {
            // Get DOM elements
            const avgDailyCaloriesAllTimeEl = document.getElementById('avg-daily-calories-all-time');
            const avgDailyCaloriesWeekEl = document.getElementById('avg-daily-calories-week');
            
            // Today's net calories (most recent entry)
            const todayEntry = entries[0];
            if (todayEntry) {
                todayNetCaloriesEl.textContent = todayEntry.netCalories;
                todayNetCaloriesEl.className = todayEntry.netCalories > 0 ? 'negative' : 'positive';
            } else {
                todayNetCaloriesEl.textContent = '--';
            }
            
            // This week's net calories (last 7 days)
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(lastWeek.getDate() - 7);
            
            const weekEntries = entries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= lastWeek && entryDate <= today;
            });
            
            const weekNetCalories = weekEntries.reduce((sum, entry) => sum + entry.netCalories, 0);
            weekNetCaloriesEl.textContent = weekNetCalories;
            weekNetCaloriesEl.className = weekNetCalories > 0 ? 'negative' : 'positive';
            
            // Calculate average daily calories for last 7 days
            const avgDailyCaloriesWeek = weekNetCalories / Math.min(7, weekEntries.length);
            avgDailyCaloriesWeekEl.textContent = avgDailyCaloriesWeek.toFixed(0);
            avgDailyCaloriesWeekEl.className = avgDailyCaloriesWeek > 0 ? 'negative' : 'positive';
            
            // Calculate average daily calories since first entry
            if (entries.length > 0) {
                const firstEntry = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date))[0];
                const firstDate = new Date(firstEntry.date);
                const daysSinceStart = Math.ceil((today - firstDate) / (1000 * 60 * 60 * 24)) || 1;
                
                const totalNetCalories = entries.reduce((sum, entry) => sum + entry.netCalories, 0);
                const avgDailyCaloriesAllTime = totalNetCalories / daysSinceStart;
                
                avgDailyCaloriesAllTimeEl.textContent = avgDailyCaloriesAllTime.toFixed(0);
                avgDailyCaloriesAllTimeEl.className = avgDailyCaloriesAllTime > 0 ? 'negative' : 'positive';
            } else {
                avgDailyCaloriesAllTimeEl.textContent = '--';
            }
            
            // Calculate theoretical weight change based on calories
            const totalNetCalories = entries.reduce((sum, entry) => sum + entry.netCalories, 0);
            const theoreticalKgChange = totalNetCalories / CALORIES_PER_KG;
            const theoreticalLbsChange = kgToLbs(Math.abs(theoreticalKgChange));
            const calorieDirection = theoreticalKgChange > 0 ? 'gain' : 'loss';
            
            theoreticalWeightChangeEl.textContent = 
                `${Math.abs(theoreticalKgChange).toFixed(2)} kg / ${theoreticalLbsChange.toFixed(2)} lbs ${calorieDirection}`;
            theoreticalWeightChangeEl.className = calorieDirection === 'loss' ? 'positive' : 'negative';
        }
        
        // Update workout stats
        function updateWorkoutStats() {
            const completedWorkoutsEl = document.getElementById('completed-workouts');
            const completionRateEl = document.getElementById('completion-rate');
            const totalVolumeEl = document.getElementById('total-volume');
            
            // Count workout logs
            const workoutDates = Object.keys(workoutLogs);
            let completedWorkouts = 0;
            let plannedWorkouts = 0;
            
            workoutDates.forEach(date => {
                const log = workoutLogs[date];
                if (log.type === 'workout') { // Only count actual workouts, not rest days
                    if (log.status === 'completed') {
                        completedWorkouts++;
                    }
                    plannedWorkouts++;
                }
            });
            
            // Calculate completion rate
            const completionRate = plannedWorkouts > 0 ? ((completedWorkouts / plannedWorkouts) * 100).toFixed(1) : 0;
            
            // Calculate total volume (weight × sets × reps) from last week
            let totalVolume = 0;
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(lastWeek.getDate() - 7);
            
            workoutDates.forEach(date => {
                const workoutDate = new Date(date);
                if (workoutDate >= lastWeek && workoutDate <= today) {
                    const log = workoutLogs[date];
                    if (log.type === 'workout' && log.status === 'completed') {
                        log.exercises.forEach(exercise => {
                            if (exercise.status === 'completed' || exercise.status === 'modified') {
                                const volume = exercise.actualWeight * exercise.actualSets * exercise.actualReps;
                                totalVolume += volume;
                            }
                        });
                    }
                }
            });
            
            // Update UI
            if (completedWorkoutsEl) completedWorkoutsEl.textContent = `${completedWorkouts} / ${plannedWorkouts}`;
            if (completionRateEl) completionRateEl.textContent = `${completionRate}%`;
            if (totalVolumeEl) totalVolumeEl.textContent = `${totalVolume.toFixed(0)} kg`;
        }
        
        // Reset stats UI
        function resetStats() {
            currentWeightEl.textContent = '--';
            startingWeightEl.textContent = '--';
            totalChangeEl.textContent = '--';
            projection7El.textContent = '--';
            projection30El.textContent = '--';
            projection60El.textContent = '--';
            todayNetCaloriesEl.textContent = '--';
            weekNetCaloriesEl.textContent = '--';
            theoreticalWeightChangeEl.textContent = '--';
            document.getElementById('completed-workouts').textContent = '--';
            document.getElementById('completion-rate').textContent = '--';
            document.getElementById('total-volume').textContent = '--';
        }
        
        // Helper function: Calculate days difference between two dates
        function daysDiff(date1, date2) {
            const diffTime = Math.abs(date2 - date1);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                switchTab(tabId);
            });
        });
        
        function switchTab(tabId) {
            // Update tab button active state
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update tab content visibility
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Special actions when switching to specific tabs
            if (tabId === 'workout-plan') {
                renderWorkoutPlan();
            } else if (tabId === 'workout-tracker') {
                loadWorkoutTracker();
            } else if (tabId === 'welcome') {
                updateWelcomeTab();
            }
        }
        
        // Initialize
        function init() {
            setTodayDate();
            renderHistory();
            updateStats();
            
            // Initialize workout plan UI
            renderWorkoutPlan();
            
            // Initialize workout tracker
            loadWorkoutTracker();
            
            // Set Welcome as the default tab
            switchTab('welcome');
            updateWelcomeTab();
            
            // Add event listeners for workout tracker buttons
            changeWorkoutBtn.addEventListener('click', function() {
                // Hide the planned workout card and show the workout selector
                plannedWorkoutCard.style.display = 'none';
                workoutSelectorCard.style.display = 'block';
                noWorkoutCard.style.display = 'none';
                
                // Update workout options
                renderWorkoutOptions();
            });
            
            // Date change listener
            trackerDateInput.addEventListener('change', function() {
                loadWorkoutForDate(this.value);
            });
            
            // Change to workout button (from rest day)
            changeToWorkoutBtn.addEventListener('click', function() {
                workoutSelectorCard.style.display = 'block';
                noWorkoutCard.style.display = 'none';
                renderWorkoutOptions();
            });
            
            // Mark all completed button
            markCompletedBtn.addEventListener('click', function() {
                const date = trackerDateInput.value;
                const workoutLog = workoutLogs[date];
                
                if (workoutLog && workoutLog.type === 'workout') {
                    workoutLog.status = 'completed';
                    workoutLog.exercises.forEach(exercise => {
                        if (exercise.status === 'planned') {
                            exercise.status = 'completed';
                            exercise.actualSets = exercise.sets;
                            exercise.actualReps = exercise.reps;
                            exercise.actualWeight = exercise.weight;
                            exercise.difficulty = 'moderate';
                        }
                    });
                    
                    // Save changes
                    localStorage.setItem('workoutLogs', JSON.stringify(workoutLogs));
                    
                    // Reload display
                    loadWorkoutForDate(date);
                }
            });
            
            // Skip workout button
            skipWorkoutBtn.addEventListener('click', function() {
                const date = trackerDateInput.value;
                const workoutLog = workoutLogs[date];
                
                if (workoutLog && workoutLog.type === 'workout') {
                    workoutLog.status = 'skipped';
                    workoutLog.exercises.forEach(exercise => {
                        if (exercise.status === 'planned') {
                            exercise.status = 'skipped';
                        }
                    });
                    
                    // Save changes
                    localStorage.setItem('workoutLogs', JSON.stringify(workoutLogs));
                    
                    // Reload display
                    loadWorkoutForDate(date);
                }
            });
            
            // Go to plan button
            goToPlanBtn.addEventListener('click', function() {
                switchTab('workout-plan');
            });
            
            // Log exercise form submit
            logExerciseForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const exerciseIndex = parseInt(logExerciseIdInput.value);
                const dayIndex = parseInt(logDayIndexInput.value);
                const date = trackerDateInput.value;
                const workoutLog = workoutLogs[date];
                
                if (workoutLog && workoutLog.type === 'workout' && 
                    workoutLog.dayIndex === dayIndex && 
                    workoutLog.exercises[exerciseIndex]) {
                    saveExerciseLog(workoutLog, exerciseIndex);
                }
            });
            
            // Add some example workout days if none exist
            if (mesocycle.days.length === 0) {
                // This is just for first-time users to have something to see
                configModeBtn.classList.add('active');
                previewModeBtn.classList.remove('active');
                configSection.style.display = 'block';
                previewSection.style.display = 'none';
            }
        }
        
        // Export data
        exportDataBtn.addEventListener('click', function() {
            if (entries.length === 0 && mesocycle.days.length === 0 && Object.keys(workoutLogs).length === 0) {
                alert('No data to export.');
                return;
            }
            
            // Create export object with metadata
            const exportData = {
                version: '1.1',
                exportDate: new Date().toISOString(),
                entries: entries,
                mesocycle: mesocycle,
                workoutLogs: workoutLogs
            };
            
            // Convert to JSON string
            const jsonString = JSON.stringify(exportData, null, 2);
            
            // Create download link
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create temporary link and trigger download
            const a = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            a.download = `fitness-tracker-data-${date}.json`;
            a.href = url;
            a.click();
            
            // Clean up
            URL.revokeObjectURL(url);
        });
        
        // Import data
        importFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    // Validate imported data
                    if (!importedData.entries || !Array.isArray(importedData.entries)) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Ask user how to handle the import
                    const importChoice = confirm(
                        'Do you want to replace all existing data with imported data?\n\n' +
                        'OK = Replace all existing data\n' +
                        'Cancel = Merge with existing data (keep both)'
                    );
                    
                    if (importChoice) {
                        // Replace all data
                        entries = importedData.entries;
                        
                        // Import workout plan data if available
                        if (importedData.mesocycle) {
                            mesocycle = importedData.mesocycle;
                        }
                        
                        // Import workout logs if available
                        if (importedData.workoutLogs) {
                            workoutLogs = importedData.workoutLogs;
                        }
                    } else {
                        // Merge entry data (avoiding duplicates by date)
                        const existingDates = new Set(entries.map(entry => entry.date));
                        
                        importedData.entries.forEach(importedEntry => {
                            if (!existingDates.has(importedEntry.date)) {
                                entries.push(importedEntry);
                            }
                        });
                        
                        // Sort entries by date
                        entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        // Merge workout plan if available
                        if (importedData.mesocycle && importedData.mesocycle.days) {
                            // For simplicity, we'll just add days that don't already exist
                            const existingDayNames = new Set(mesocycle.days.map(day => day.name));
                            
                            importedData.mesocycle.days.forEach(day => {
                                if (!existingDayNames.has(day.name)) {
                                    mesocycle.days.push(day);
                                }
                            });
                        }
                        
                        // Merge workout logs if available
                        if (importedData.workoutLogs) {
                            workoutLogs = { ...workoutLogs, ...importedData.workoutLogs };
                        }
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('fitnessEntries', JSON.stringify(entries));
                    localStorage.setItem('mesocycle', JSON.stringify(mesocycle));
                    localStorage.setItem('workoutLogs', JSON.stringify(workoutLogs));
                    
                    // Update UI
                    renderHistory();
                    updateStats();
                    renderWorkoutPlan();
                    loadWorkoutTracker();
                    
                    alert('Data imported successfully!');
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing data. Please make sure the file is a valid fitness tracker export.');
                }
                
                // Reset the file input
                importFileInput.value = '';
            };
            
            reader.readAsText(file);
        });
        
        // Weight Chart Functions
        function updateWeightChart(range) {
            // Filter entries with weight data
            let weightEntries = entries.filter(entry => entry.weightKg !== null);
            
            if (weightEntries.length === 0) {
                // Clear chart if no data
                if (weightChart) {
                    weightChart.destroy();
                    weightChart = null;
                }
                resetGraphSummary();
                return;
            }
            
            // Sort entries by date (oldest first for the chart)
            weightEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Filter based on selected time range
            const today = new Date();
            let filteredEntries = [];
            
            switch(range) {
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    filteredEntries = weightEntries.filter(entry => new Date(entry.date) >= weekAgo);
                    break;
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    filteredEntries = weightEntries.filter(entry => new Date(entry.date) >= monthAgo);
                    break;
                case '3month':
                    const threeMonthsAgo = new Date(today);
                    threeMonthsAgo.setMonth(today.getMonth() - 3);
                    filteredEntries = weightEntries.filter(entry => new Date(entry.date) >= threeMonthsAgo);
                    break;
                case 'year':
                    const yearAgo = new Date(today);
                    yearAgo.setFullYear(today.getFullYear() - 1);
                    filteredEntries = weightEntries.filter(entry => new Date(entry.date) >= yearAgo);
                    break;
                case 'all':
                default:
                    filteredEntries = [...weightEntries];
                    break;
            }
            
            // If no entries in the range, try to fall back to a wider range
            if (filteredEntries.length === 0) {
                if (range === 'week') {
                    return updateWeightChart('month');
                } else if (range === 'month') {
                    return updateWeightChart('3month');
                } else if (range === '3month') {
                    return updateWeightChart('year');
                } else if (range === 'year') {
                    return updateWeightChart('all');
                } else {
                    // No data at all for any time range
                    if (weightChart) {
                        weightChart.destroy();
                        weightChart = null;
                    }
                    resetGraphSummary();
                    return;
                }
            }
            
            // Prepare data for chart - using proper timestamps for x-axis
            const chartData = filteredEntries.map(entry => ({
                x: entry.date, // Use ISO date string directly
                y: entry.weightKg
            }));
            
            // Calculate summary stats for this range
            updateGraphSummary(filteredEntries);
            
            // Create or update chart
            const ctx = document.getElementById('weightChart').getContext('2d');
            
            const chartConfig = {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Weight (kg)',
                        data: chartData,
                        backgroundColor: 'rgba(74, 111, 165, 0.2)',
                        borderColor: 'rgba(74, 111, 165, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(74, 111, 165, 1)',
                        pointBorderColor: '#fff',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return moment(context[0].parsed.x).format('MMM D, YYYY');
                                },
                                label: function(context) {
                                    const kg = context.parsed.y;
                                    const lbs = kgToLbs(kg).toFixed(1);
                                    return `Weight: ${kg} kg / ${lbs} lbs`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: getTimeUnit(range),
                                displayFormats: {
                                    day: 'MMM D',
                                    week: 'MMM D',
                                    month: 'MMM YYYY'
                                },
                                tooltipFormat: 'MMM D, YYYY'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            adapters: {
                                date: {
                                    locale: 'en'
                                }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Weight (kg)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' kg';
                                }
                            },
                            // Set a more appropriate y-axis min/max range based on data
                            // to prevent extreme changes from looking flat
                            suggestedMin: calculateYAxisMin(filteredEntries),
                            suggestedMax: calculateYAxisMax(filteredEntries)
                        }
                    }
                }
            };
            
            if (weightChart) {
                // Update existing chart
                weightChart.data.datasets[0].data = chartData;
                weightChart.options.scales.x.time.unit = getTimeUnit(range);
                weightChart.options.scales.y.suggestedMin = calculateYAxisMin(filteredEntries);
                weightChart.options.scales.y.suggestedMax = calculateYAxisMax(filteredEntries);
                weightChart.update();
            } else {
                // Create new chart
                weightChart = new Chart(ctx, chartConfig);
            }
        }
        
        // Helper function to determine the appropriate time unit based on date range
        function getTimeUnit(range) {
            switch(range) {
                case 'week':
                    return 'day';
                case 'month':
                    return 'day';
                case '3month':
                    return 'week';
                case 'year':
                case 'all':
                    return 'month';
                default:
                    return 'day';
            }
        }
        
        // Calculate appropriate y-axis minimum value (to better visualize small changes)
        function calculateYAxisMin(entries) {
            if (entries.length === 0) return 0;
            
            const minWeight = Math.min(...entries.map(entry => entry.weightKg));
            // Set minimum to be slightly less than the minimum weight for better visualization
            return Math.floor(minWeight * 0.995);
        }
        
        // Calculate appropriate y-axis maximum value
        function calculateYAxisMax(entries) {
            if (entries.length === 0) return 100;
            
            const maxWeight = Math.max(...entries.map(entry => entry.weightKg));
            // Set maximum to be slightly more than the maximum weight
            return Math.ceil(maxWeight * 1.005);
        }
        
        // Update graph summary statistics
        function updateGraphSummary(filteredEntries) {
            if (filteredEntries.length === 0) {
                resetGraphSummary();
                return;
            }
            
            // First and last entry in the filtered range
            const firstEntry = filteredEntries[0];
            const lastEntry = filteredEntries[filteredEntries.length - 1];
            
            const startWeight = firstEntry.weightKg;
            const endWeight = lastEntry.weightKg;
            const weightChange = endWeight - startWeight;
            const changeDirection = weightChange < 0 ? 'loss' : 'gain';
            
            // Calculate average daily change
            const daysDifference = daysDiff(new Date(firstEntry.date), new Date(lastEntry.date)) || 1; // Prevent division by zero
            const dailyChange = weightChange / daysDifference;
            
            // Update UI elements
            graphStartingWeightEl.textContent = `${startWeight.toFixed(1)} kg / ${kgToLbs(startWeight).toFixed(1)} lbs`;
            graphEndingWeightEl.textContent = `${endWeight.toFixed(1)} kg / ${kgToLbs(endWeight).toFixed(1)} lbs`;
            
            graphWeightChangeEl.textContent = 
                `${Math.abs(weightChange).toFixed(1)} kg / ${kgToLbs(Math.abs(weightChange)).toFixed(1)} lbs ${changeDirection}`;
            graphWeightChangeEl.className = changeDirection === 'loss' ? 'positive' : 'negative';
            
            graphDailyChangeEl.textContent = 
                `${Math.abs(dailyChange).toFixed(2)} kg / ${kgToLbs(Math.abs(dailyChange)).toFixed(2)} lbs per day`;
            graphDailyChangeEl.className = (changeDirection === 'loss') ? 'positive' : 'negative';
        }
        
        // Reset graph summary display
        function resetGraphSummary() {
            graphStartingWeightEl.textContent = '--';
            graphEndingWeightEl.textContent = '--';
            graphWeightChangeEl.textContent = '--';
            graphDailyChangeEl.textContent = '--';
        }
        
        // Event listener for graph time range buttons
        graphBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active button
                graphBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Update chart with selected range
                const range = this.getAttribute('data-range');
                updateWeightChart(range);
            });
        });
        
        // Edit Entry Functions
        function openEditModal(index) {
            const entry = entries[index];
            if (!entry) return;
            
            // Populate form fields
            editEntryIndexInput.value = index;
            editDateInput.value = entry.date;
            
            if (entry.weightKg !== null) {
                editWeightKgInput.value = entry.weightKg;
                editWeightLbsInput.value = kgToLbs(entry.weightKg).toFixed(1);
            } else {
                editWeightKgInput.value = '';
                editWeightLbsInput.value = '';
            }
            
            editCaloriesIntakeInput.value = entry.caloriesIntake || '';
            editCaloriesBurnedInput.value = entry.caloriesBurned || '';
            
            // Set workouts
            editSelectedWorkouts = [...(entry.workouts || [])];
            renderEditSelectedWorkouts();
            
            // Show modal
            editModal.style.display = 'flex';
        }
        
        // Close the edit modal
        function closeEditModal() {
            editModal.style.display = 'none';
            editForm.reset();
            editSelectedWorkouts = [];
            renderEditSelectedWorkouts();
        }
        
        // Add workout to the edit form list
        editAddWorkoutBtn.addEventListener('click', function() {
            let workout = '';
            
            if (editWorkoutSelect.value) {
                workout = editWorkoutSelect.value;
            } else if (editCustomWorkoutInput.value.trim()) {
                workout = editCustomWorkoutInput.value.trim();
            }
            
            if (workout && !editSelectedWorkouts.includes(workout)) {
                editSelectedWorkouts.push(workout);
                renderEditSelectedWorkouts();
                
                // Reset inputs
                editWorkoutSelect.value = '';
                editCustomWorkoutInput.value = '';
            }
        });
        
        // Render selected workouts in edit form
        function renderEditSelectedWorkouts() {
            editSelectedWorkoutsContainer.innerHTML = '';
            
            editSelectedWorkouts.forEach(workout => {
                const workoutItem = document.createElement('div');
                workoutItem.className = 'workout-item';
                
                workoutItem.innerHTML = `
                    <span>${workout}</span>
                    <button type="button" data-workout="${workout}">&times;</button>
                `;
                
                editSelectedWorkoutsContainer.appendChild(workoutItem);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('#edit-selected-workouts .workout-item button').forEach(button => {
                button.addEventListener('click', function() {
                    const workoutToRemove = this.getAttribute('data-workout');
                    editSelectedWorkouts = editSelectedWorkouts.filter(w => w !== workoutToRemove);
                    renderEditSelectedWorkouts();
                });
            });
        }
        
        // Cancel edit
        cancelEditBtn.addEventListener('click', closeEditModal);
        
        // Save edited entry
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const index = parseInt(editEntryIndexInput.value);
            if (isNaN(index) || index < 0 || index >= entries.length) {
                closeEditModal();
                return;
            }
            
            const date = editDateInput.value;
            const weightKg = parseFloat(editWeightKgInput.value) || null;
            const caloriesIntake = parseInt(editCaloriesIntakeInput.value) || 0;
            const caloriesBurned = parseInt(editCaloriesBurnedInput.value) || 0;
            const netCalories = caloriesIntake - caloriesBurned;
            
            // Update entry
            entries[index] = {
                date,
                weightKg,
                workouts: [...editSelectedWorkouts],
                caloriesIntake,
                caloriesBurned,
                netCalories
            };
            
            // Sort entries by date (newest first)
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Save to localStorage
            localStorage.setItem('fitnessEntries', JSON.stringify(entries));
            
            // Update UI
            renderHistory();
            updateStats();
            updateWelcomeTab();
            
            // Close modal
            closeEditModal();
        });
        
        // Workout Plan Functions
        function renderWorkoutPlan() {
            // Update form with current mesocycle data
            mesocycleNameInput.value = mesocycle.name || '';
            mesocycleWeeksInput.value = mesocycle.weeks || 6;
            overloadStrategySelect.value = mesocycle.strategy || 'mixed';
            
            // Render workout days
            renderWorkoutDays();
            
            // Reset current day selection
            currentDayIndex = -1;
            
            // Show notification if no days added yet
            updateDaySelection();
        }
        
        // Render workout days
        function renderWorkoutDays() {
            daySelector.innerHTML = '';
            
            if (mesocycle.days.length === 0) {
                noDaySelected.style.display = 'block';
                addExerciseBtn.style.display = 'none';
                exerciseList.innerHTML = '';
                return;
            }
            
            // Calculate total weekly sets
            const totalWeeklySets = mesocycle.days.reduce((total, day) => {
                return total + day.exercises.reduce((dayTotal, exercise) => dayTotal + (exercise.sets || 0), 0);
            }, 0);
            
            // Add weekly sets summary
            const weeklySetsSummary = document.createElement('div');
            weeklySetsSummary.className = 'weekly-sets-summary';
            weeklySetsSummary.innerHTML = `<h3>Total Weekly Sets: ${totalWeeklySets}</h3>`;
            daySelector.appendChild(weeklySetsSummary);
            
            mesocycle.days.forEach((day, index) => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                dayCard.setAttribute('data-index', index);
                
                dayCard.innerHTML = `
                    <h3>${day.name}</h3>
                    <div>${day.exercises.length} exercises | ${day.exercises.reduce((total, exercise) => total + (exercise.sets || 0), 0)} sets</div>
                `;
                
                dayCard.addEventListener('click', () => {
                    selectWorkoutDay(index);
                });
                
                daySelector.appendChild(dayCard);
            });
        }
        
        // Select workout day
        function selectWorkoutDay(index) {
            // Update current selection
            currentDayIndex = index;
            
            // Update UI to show current selection
            document.querySelectorAll('.day-card').forEach((card, i) => {
                if (i === index) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
            
            // Show exercises for selected day
            renderExercises();
            
            // Update visibility
            updateDaySelection();
        }
        
        // Update UI based on day selection
        function updateDaySelection() {
            if (currentDayIndex >= 0 && mesocycle.days.length > 0) {
                noDaySelected.style.display = 'none';
                addExerciseBtn.style.display = 'block';
                exerciseList.style.display = 'block';
            } else {
                if (mesocycle.days.length === 0) {
                    noDaySelected.innerHTML = 'Please add a workout day to configure exercises.';
                } else {
                    noDaySelected.innerHTML = 'Please select a workout day to view or edit exercises.';
                }
                noDaySelected.style.display = 'block';
                addExerciseBtn.style.display = 'none';
                exerciseList.style.display = 'none';
            }
        }
        
        // Render exercises for current day
        function renderExercises() {
            exerciseList.innerHTML = '';
            
            if (currentDayIndex < 0 || !mesocycle.days[currentDayIndex]) {
                return;
            }
            
            const day = mesocycle.days[currentDayIndex];
            
            if (day.exercises.length === 0) {
                exerciseList.innerHTML = '<div class="card-notice">No exercises added yet. Click "Add Exercise" to get started.</div>';
                return;
            }
            
            day.exercises.forEach((exercise, index) => {
                const exerciseCard = document.createElement('div');
                exerciseCard.className = 'exercise-card';
                
                exerciseCard.innerHTML = `
                    <div class="actions">
                        <button type="button" class="edit-exercise" data-index="${index}">Edit</button>
                        <button type="button" class="delete-exercise" data-index="${index}">Delete</button>
                    </div>
                    <h3>${exercise.name} <span class="tag">${exercise.category}</span></h3>
                    <div class="exercise-details">
                        <div class="exercise-detail">
                            <span>Sets:</span>
                            ${exercise.sets}
                        </div>
                        <div class="exercise-detail">
                            <span>Target Reps:</span>
                            ${exercise.reps}
                        </div>
                        <div class="exercise-detail">
                            <span>Weight:</span>
                            ${exercise.weight} kg
                        </div>
                        <div class="exercise-detail">
                            <span>Rest:</span>
                            ${exercise.rest ? exercise.rest + ' sec' : 'Not specified'}
                        </div>
                    </div>
                    ${exercise.notes ? '<div class="exercise-notes"><span>Notes:</span> ' + exercise.notes + '</div>' : ''}
                `;
                
                exerciseList.appendChild(exerciseCard);
            });
            
            // Add event listeners to edit/delete buttons
            document.querySelectorAll('.edit-exercise').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    openExerciseForm(index);
                });
            });
            
            document.querySelectorAll('.delete-exercise').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteExercise(index);
                });
            });
        }
        
        // Open exercise form
        function openExerciseForm(exerciseIndex = -1) {
            exerciseForm.reset();
            
            if (exerciseIndex >= 0 && mesocycle.days[currentDayIndex] && mesocycle.days[currentDayIndex].exercises[exerciseIndex]) {
                // Edit mode
                exerciseFormTitle.textContent = 'Edit Exercise';
                
                const exercise = mesocycle.days[currentDayIndex].exercises[exerciseIndex];
                
                exerciseNameInput.value = exercise.name;
                exerciseCategorySelect.value = exercise.category;
                exerciseSetsInput.value = exercise.sets;
                exerciseRepsInput.value = exercise.reps;
                exerciseWeightInput.value = exercise.weight;
                exerciseRestInput.value = exercise.rest || '';
                exerciseNotesInput.value = exercise.notes || '';
                
                editExerciseIndexInput.value = exerciseIndex;
            } else {
                // Add mode
                exerciseFormTitle.textContent = 'Add Exercise';
                editExerciseIndexInput.value = -1;
            }
            
            editDayIndexInput.value = currentDayIndex;
            
            exerciseFormModal.style.display = 'flex';
        }
        
        // Delete exercise
        function deleteExercise(index) {
            if (confirm('Are you sure you want to delete this exercise?')) {
                mesocycle.days[currentDayIndex].exercises.splice(index, 1);
                
                // Save changes
                saveMesocycle();
                
                // Update UI
                renderExercises();
            }
        }
        
        // Close exercise form
        function closeExerciseForm() {
            exerciseFormModal.style.display = 'none';
        }
        
        // Save exercise
        exerciseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dayIndex = parseInt(editDayIndexInput.value);
            const exerciseIndex = parseInt(editExerciseIndexInput.value);
            
            if (dayIndex < 0 || dayIndex >= mesocycle.days.length) {
                alert('No workout day selected.');
                return;
            }
            
            const exerciseData = {
                name: exerciseNameInput.value,
                category: exerciseCategorySelect.value,
                sets: parseInt(exerciseSetsInput.value),
                reps: parseInt(exerciseRepsInput.value),
                weight: parseFloat(exerciseWeightInput.value),
                rest: exerciseRestInput.value ? parseInt(exerciseRestInput.value) : null,
                notes: exerciseNotesInput.value.trim() || null
            };
            
            if (exerciseIndex >= 0) {
                // Update existing exercise
                mesocycle.days[dayIndex].exercises[exerciseIndex] = exerciseData;
            } else {
                // Add new exercise
                mesocycle.days[dayIndex].exercises.push(exerciseData);
            }
            
            // Save changes
            saveMesocycle();
            
            // Update UI
            renderExercises();
            
            // Close form
            closeExerciseForm();
        });
        
        // Cancel exercise form
        cancelExerciseFormBtn.addEventListener('click', closeExerciseForm);
        
        // Add day button
        addDayBtn.addEventListener('click', function() {
            const dayName = prompt('Enter name for new workout day (e.g. "Day 1 - Push", "Monday - Legs"):');
            
            if (dayName) {
                mesocycle.days.push({
                    name: dayName,
                    exercises: []
                });
                
                // Save changes
                saveMesocycle();
                
                // Update UI
                renderWorkoutDays();
                
                // Select the new day
                selectWorkoutDay(mesocycle.days.length - 1);
            }
        });
        
        // Add exercise button
        addExerciseBtn.addEventListener('click', function() {
            openExerciseForm();
        });
        
        // Toggle between config and preview
        configModeBtn.addEventListener('click', function() {
            configModeBtn.classList.add('active');
            previewModeBtn.classList.remove('active');
            configSection.style.display = 'block';
            previewSection.style.display = 'none';
        });
        
        previewModeBtn.addEventListener('click', function() {
            configModeBtn.classList.remove('active');
            previewModeBtn.classList.add('active');
            configSection.style.display = 'none';
            previewSection.style.display = 'block';
            
            // Generate preview
            generateMesocyclePreview();
        });
        
        // Generate mesocycle preview
        function generateMesocyclePreview() {
            mesocyclePreview.innerHTML = '';
            
            const weeks = parseInt(mesocycleWeeksInput.value) || 6;
            const strategy = overloadStrategySelect.value;
            
            // Generate preview for each week
            for (let week = 1; week <= weeks; week++) {
                const weekCard = document.createElement('div');
                weekCard.className = 'mesocycle-week';
                weekCard.innerHTML = `<h3>Week ${week}</h3>`;
                
                // Create summary for each day
                let daysSummary = document.createElement('div');
                
                if (mesocycle.days.length === 0) {
                    daysSummary.innerHTML = '<p>No workout days configured.</p>';
                } else {
                    mesocycle.days.forEach(day => {
                        const dayPreview = document.createElement('div');
                        dayPreview.style.marginBottom = '10px';
                        
                        dayPreview.innerHTML = `<h4>${day.name}</h4>`;
                        
                        if (day.exercises.length === 0) {
                            dayPreview.innerHTML += '<p>No exercises configured.</p>';
                        } else {
                            const exercisesList = document.createElement('ul');
                            exercisesList.style.padding = '0 0 0 20px';
                            
                            day.exercises.forEach(baseExercise => {
                                // Clone the exercise to avoid modifying the original
                                const exercise = { ...baseExercise };
                                
                                // Apply progressive overload based on week and strategy
                                if (week > 1) {
                                    applyProgressiveOverload(exercise, week, strategy);
                                }
                                
                                const exerciseItem = document.createElement('li');
                                exerciseItem.style.marginBottom = '5px';
                                exerciseItem.innerHTML = `${exercise.name}: ${exercise.sets} sets × ${exercise.reps} reps @ ${exercise.weight} kg`;
                                
                                exercisesList.appendChild(exerciseItem);
                            });
                            
                            dayPreview.appendChild(exercisesList);
                        }
                        
                        daysSummary.appendChild(dayPreview);
                    });
                }
                
                weekCard.appendChild(daysSummary);
                mesocyclePreview.appendChild(weekCard);
            }
        }
        
        // Apply progressive overload to an exercise
        function applyProgressiveOverload(exercise, week, strategy) {
            const weekFactor = week - 1; // Week 1 is baseline
            
            switch (strategy) {
                case 'weight':
                    // Increase weight by 2.5-5% per week
                    exercise.weight = Math.round((exercise.weight * (1 + (0.025 * weekFactor))) * 2) / 2; // Round to nearest 0.5
                    break;
                    
                case 'reps':
                    // Increase reps by 1-2 per week, up to a limit
                    exercise.reps = Math.min(exercise.reps + (weekFactor * 2), 20); // Cap at 20 reps
                    break;
                    
                case 'sets':
                    // Increase sets every 2 weeks, up to a limit
                    exercise.sets = Math.min(exercise.sets + Math.floor(weekFactor / 2), 5); // Cap at 5 sets
                    break;
                    
                case 'mixed':
                default:
                    // Alternating approach
                    if (weekFactor % 3 === 0) {
                        // Increase weight
                        exercise.weight = Math.round((exercise.weight * 1.025) * 2) / 2;
                    } else if (weekFactor % 3 === 1) {
                        // Increase reps
                        exercise.reps = Math.min(exercise.reps + 1, 15);
                    } else {
                        // Increase sets
                        exercise.sets = Math.min(exercise.sets + 1, 5);
                    }
                    break;
            }
        }
        
        // Save mesocycle button
        saveMesocycleBtn.addEventListener('click', function() {
            mesocycle.name = mesocycleNameInput.value || "My Workout Plan";
            mesocycle.weeks = parseInt(mesocycleWeeksInput.value) || 6;
            mesocycle.strategy = overloadStrategySelect.value;
            
            saveMesocycle();
            alert('Workout plan saved successfully!');
        });
        
        // Export mesocycle button
        exportMesocycleBtn.addEventListener('click', function() {
            if (mesocycle.days.length === 0) {
                alert('No workout plan to export. Please create a plan first.');
                return;
            }
            
            // Create export object with metadata
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                mesocycleName: mesocycle.name,
                mesocycle: mesocycle
            };
            
            // Convert to JSON string
            const jsonString = JSON.stringify(exportData, null, 2);
            
            // Create download link
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create temporary link and trigger download
            const a = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            const safeFileName = mesocycle.name.replace(/[^a-z0-9]/gi, '-').toLowerCase();
            a.download = `${safeFileName}-${date}.json`;
            a.href = url;
            a.click();
            
            // Clean up
            URL.revokeObjectURL(url);
        });
        
        // Import mesocycle
        importMesocycleFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    // Validate imported data
                    if (!importedData.mesocycle) {
                        throw new Error('Invalid mesocycle data format');
                    }
                    
                    // Ask user how to handle the import
                    const importChoice = confirm(
                        'Do you want to replace your current workout plan with the imported plan?\n\n' +
                        'OK = Replace current plan\n' +
                        'Cancel = Keep both (will add imported days to your current plan)'
                    );
                    
                    if (importChoice) {
                        // Replace current mesocycle
                        mesocycle = importedData.mesocycle;
                    } else {
                        // Merge with existing mesocycle
                        // Keep strategy and weeks from current plan
                        
                        // Add days from imported plan
                        const existingDayNames = new Set(mesocycle.days.map(day => day.name));
                        
                        importedData.mesocycle.days.forEach(day => {
                            // If day with same name exists, add a suffix
                            let newDayName = day.name;
                            let counter = 1;
                            
                            while (existingDayNames.has(newDayName)) {
                                newDayName = `${day.name} (${counter})`;
                                counter++;
                            }
                            
                            // Add the day with possibly modified name
                            const newDay = {...day, name: newDayName};
                            mesocycle.days.push(newDay);
                            existingDayNames.add(newDayName);
                        });
                    }
                    
                    // Save changes
                    saveMesocycle();
                    
                    // Update UI
                    renderWorkoutPlan();
                    
                    alert('Workout plan imported successfully!');
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing workout plan. Please make sure the file contains a valid mesocycle plan.');
                }
                
                // Reset the file input
                importMesocycleFileInput.value = '';
            };
            
            reader.readAsText(file);
        });
        
        // Reset mesocycle button
        resetMesocycleBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to reset your workout plan? This will remove all days and exercises.')) {
                mesocycle = {
                    name: "My Workout Plan",
                    weeks: 6,
                    strategy: "mixed",
                    days: []
                };
                
                saveMesocycle();
                renderWorkoutPlan();
                
                alert('Workout plan has been reset.');
            }
        });
        
        // Save mesocycle to localStorage
        function saveMesocycle() {
            localStorage.setItem('mesocycle', JSON.stringify(mesocycle));
        }
        
        // Workout Tracker Functions
        function loadWorkoutTracker() {
            // Set initial date if not set
            if (!trackerDateInput.value) {
                setTodayDate();
            }
            
            // Load and display workout for selected date
            const selectedDate = trackerDateInput.value;
            loadWorkoutForDate(selectedDate);
        }

        function renderWorkoutOptions() {
            workoutOptionsContainer.innerHTML = '';
            
            // Add rest day option
            const restDayOption = document.createElement('div');
            restDayOption.className = 'workout-option rest-day';
            restDayOption.innerHTML = `
                <h4>Rest Day</h4>
                <div class="exercise-count">No exercises planned</div>
            `;
            restDayOption.addEventListener('click', () => selectWorkoutOption('rest'));
            workoutOptionsContainer.appendChild(restDayOption);
            
            // Add workout day options from mesocycle
            mesocycle.days.forEach((day, index) => {
                const workoutOption = document.createElement('div');
                workoutOption.className = 'workout-option';
                workoutOption.innerHTML = `
                    <h4>${day.name}</h4>
                    <div class="exercise-count">${day.exercises.length} exercises | ${day.exercises.reduce((total, exercise) => total + (exercise.sets || 0), 0)} sets</div>
                `;
                workoutOption.addEventListener('click', () => selectWorkoutOption('workout', index));
                workoutOptionsContainer.appendChild(workoutOption);
            });
            
            // Update date display
            const displayDate = new Date(trackerDateInput.value).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            workoutDateDisplay.textContent = displayDate;
        }

        function selectWorkoutOption(type, dayIndex = -1) {
            const selectedDate = trackerDateInput.value;
            
            if (type === 'rest') {
                // Set as rest day
                workoutLogs[selectedDate] = {
                    type: 'rest',
                    date: selectedDate
                };
            } else {
                // Set as workout day
                const selectedDay = mesocycle.days[dayIndex];
                workoutLogs[selectedDate] = {
                    type: 'workout',
                    date: selectedDate,
                    dayIndex: dayIndex,
                    dayName: selectedDay.name,
                    exercises: selectedDay.exercises.map(ex => ({
                        ...ex,
                        status: 'planned'
                    })),
                    status: 'planned'
                };
            }
            
            // Save to localStorage
            localStorage.setItem('workoutLogs', JSON.stringify(workoutLogs));
            
            // Reload the workout display
            loadWorkoutForDate(selectedDate);
            updateWelcomeTab();
        }
        
        // Load workout for selected date
        function loadWorkoutForDate(date) {
            // Format the date for display
            const displayDate = new Date(date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            workoutDateDisplay.textContent = displayDate;
            workoutDateDisplay2.textContent = displayDate;
            
            // Check if there are any workout days defined
            if (mesocycle.days.length === 0) {
                workoutSelectorCard.style.display = 'block';
                plannedWorkoutCard.style.display = 'none';
                noWorkoutCard.style.display = 'none';
                noWorkoutsNotice.style.display = 'block';
                workoutOptionsContainer.style.display = 'none';
                return;
            }
            
            // Get workout log for this date
            const workoutLog = workoutLogs[date];
            
            if (!workoutLog) {
                // No workout selected yet - show workout selector
                workoutSelectorCard.style.display = 'block';
                plannedWorkoutCard.style.display = 'none';
                noWorkoutCard.style.display = 'none';
                noWorkoutsNotice.style.display = 'none';
                workoutOptionsContainer.style.display = 'block';
                renderWorkoutOptions();
                return;
            }
            
            if (workoutLog.type === 'rest') {
                // Rest day
                workoutSelectorCard.style.display = 'none';
                plannedWorkoutCard.style.display = 'none';
                noWorkoutCard.style.display = 'block';
                exerciseTrackerList.innerHTML = '';
                markCompletedBtn.style.display = 'none';
                skipWorkoutBtn.style.display = 'none';
            } else {
                // Workout day
                workoutSelectorCard.style.display = 'none';
                plannedWorkoutCard.style.display = 'block';
                noWorkoutCard.style.display = 'none';
                
                // Display workout info
                workoutDayName.textContent = workoutLog.dayName;
                
                // Show completion status
                let statusText = '';
                let statusClass = '';
                switch(workoutLog.status) {
                    case 'completed':
                        statusText = 'Completed';
                        statusClass = 'positive';
                        break;
                    case 'skipped':
                        statusText = 'Skipped';
                        statusClass = 'negative';
                        break;
                    case 'in_progress':
                        statusText = 'In Progress';
                        statusClass = 'warning';
                        break;
                    default:
                        statusText = 'Planned';
                        statusClass = '';
                }
                workoutCompletionStatus.textContent = `Status: ${statusText}`;
                workoutCompletionStatus.className = statusClass;
                
                // Render exercise list
                renderExerciseTracker(workoutLog);
                
                // Show/hide action buttons based on status
                markCompletedBtn.style.display = workoutLog.status === 'planned' || workoutLog.status === 'in_progress' ? 'block' : 'none';
                skipWorkoutBtn.style.display = workoutLog.status === 'planned' || workoutLog.status === 'in_progress' ? 'block' : 'none';
            }
        }

        function renderExerciseTracker(workoutLog) {
            exerciseTrackerList.innerHTML = '';
            
            workoutLog.exercises.forEach((exercise, index) => {
                const exerciseCard = document.createElement('div');
                exerciseCard.className = 'exercise-card';
                
                let statusDisplay = '';
                switch(exercise.status) {
                    case 'completed':
                        statusDisplay = '<span class="exercise-status status-completed"></span>Completed';
                        break;
                    case 'modified':
                        statusDisplay = '<span class="exercise-status status-modified"></span>Modified';
                        break;
                    case 'skipped':
                        statusDisplay = '<span class="exercise-status status-missed"></span>Skipped';
                        break;
                    default:
                        statusDisplay = '<span class="exercise-status status-planned"></span>Planned';
                }

                let detailsHtml = '';
                if (exercise.status === 'completed') {
                    // Show actual values for completed exercises
                    let setsHtml = '';
                    
                    // Handle both old and new format exercises
                    if (exercise.actualRepsPerSet && exercise.actualWeightPerSet) {
                        // New format with per-set data
                        setsHtml = exercise.actualRepsPerSet.map((reps, idx) => 
                            `<div class="exercise-detail">
                                <span>Set ${idx + 1}:</span> ${reps} reps at ${exercise.actualWeightPerSet[idx]} kg 
                                (Target: ${exercise.reps} reps at ${exercise.weight} kg)
                            </div>`
                        ).join('');
                    } else {
                        // Old format with single values
                        setsHtml = Array(exercise.actualSets).fill(0).map((_, idx) => 
                            `<div class="exercise-detail">
                                <span>Set ${idx + 1}:</span> ${exercise.actualReps} reps at ${exercise.actualWeight} kg 
                                (Target: ${exercise.reps} reps at ${exercise.weight} kg)
                            </div>`
                        ).join('');
                    }

                    detailsHtml = `
                        <div class="exercise-details">
                            <div class="exercise-detail">
                                <span>Sets Completed:</span> ${exercise.actualSets}
                            </div>
                            <div class="exercise-detail">
                                <span>Set Details:</span>
                            </div>
                            ${setsHtml}
                            <div class="exercise-detail">
                                <span>Average Weight:</span>
                                ${exercise.actualWeight} kg
                            </div>
                            <div class="exercise-detail">
                                <span>Difficulty:</span>
                                ${exercise.difficulty}
                            </div>
                            ${exercise.notes ? `<div class="exercise-detail"><span>Notes:</span> ${exercise.notes}</div>` : ''}
                        </div>
                    `;
                } else {
                    // Show planned values for non-completed exercises
                    detailsHtml = `
                        <div class="exercise-details">
                            <div class="exercise-detail">
                                <span>Sets:</span>
                                ${exercise.sets}
                            </div>
                            <div class="exercise-detail">
                                <span>Target Reps:</span>
                                ${exercise.reps} per set
                            </div>
                            <div class="exercise-detail">
                                <span>Target Weight:</span>
                                ${exercise.weight} kg
                            </div>
                        </div>
                    `;
                }
                
                exerciseCard.innerHTML = `
                    <h3>${exercise.name}</h3>
                    <div class="tag">${exercise.category}</div>
                    <div style="margin-top: 10px;">${statusDisplay}</div>
                    ${detailsHtml}
                `;
                
                // Add appropriate button based on exercise status
                if (exercise.status === 'planned') {
                    const logButton = document.createElement('button');
                    logButton.textContent = 'Log Exercise';
                    logButton.className = 'btn-primary';
                    logButton.style.marginTop = '10px';
                    logButton.addEventListener('click', () => openLogExerciseModal(workoutLog, index));
                    exerciseCard.appendChild(logButton);
                } else if (exercise.status === 'completed' || exercise.status === 'modified') {
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit Log';
                    editButton.className = 'btn-secondary';
                    editButton.style.marginTop = '10px';
                    editButton.addEventListener('click', () => openLogExerciseModal(workoutLog, index));
                    exerciseCard.appendChild(editButton);
                }
                
                exerciseTrackerList.appendChild(exerciseCard);
            });
        }
        
        // Function to open the log exercise modal
        function openLogExerciseModal(workoutLog, exerciseIndex) {
            const exercise = workoutLog.exercises[exerciseIndex];
            const isEditing = exercise.status === 'completed' || exercise.status === 'modified';
            
            // Set exercise info in the modal
            const logExerciseInfo = document.getElementById('log-exercise-info');
            if (!logExerciseInfo) {
                console.error('Exercise info container not found');
                return;
            }
            logExerciseInfo.innerHTML = `
                <h3>${exercise.name}</h3>
                <div class="tag">${exercise.category}</div>
            `;
            
            // Set planned details
            const plannedDetails = document.getElementById('planned-details');
            if (!plannedDetails) {
                console.error('Planned details container not found');
                return;
            }
            plannedDetails.innerHTML = `
                <div class="exercise-detail">
                    <span>Sets:</span> ${exercise.sets}
                </div>
                <div class="exercise-detail">
                    <span>Target Weight:</span> ${exercise.weight} kg
                </div>
            `;

            // Create input fields for each set
            const setsContainer = document.createElement('div');
            setsContainer.className = 'sets-container';
            setsContainer.style.marginBottom = '20px';
            
            // Add header for the sets
            setsContainer.innerHTML = `
                <h4 style="margin-bottom: 15px;">${isEditing ? 'Edit Sets' : 'Log Sets'}</h4>
                <div class="set-row header" style="display: grid; grid-template-columns: 80px 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; font-weight: bold;">
                    <div>Set</div>
                    <div>Target Reps</div>
                    <div>Actual Reps</div>
                    <div>Weight (kg)</div>
                </div>
            `;

            // Create input fields for each set
            for (let i = 0; i < exercise.sets; i++) {
                const setRow = document.createElement('div');
                setRow.className = 'set-row';
                setRow.style.display = 'grid';
                setRow.style.gridTemplateColumns = '80px 1fr 1fr 1fr';
                setRow.style.gap = '10px';
                setRow.style.marginBottom = '10px';
                setRow.style.alignItems = 'center';

                // Get existing values if editing
                const existingReps = isEditing && exercise.actualRepsPerSet ? exercise.actualRepsPerSet[i] : exercise.reps;
                const existingWeight = isEditing && exercise.actualWeightPerSet ? exercise.actualWeightPerSet[i] : exercise.weight;

                setRow.innerHTML = `
                    <div>Set ${i + 1}</div>
                    <div>${exercise.reps}</div>
                    <input type="number" 
                           class="actual-reps-input" 
                           id="actualRepsSet${i}" 
                           value="${existingReps}"
                           min="0"
                           style="width: 100%; padding: 5px;">
                    <input type="number"
                           class="actual-weight-input"
                           id="actualWeightSet${i}"
                           value="${existingWeight}"
                           min="0"
                           step="0.5"
                           style="width: 100%; padding: 5px;">
                `;

                setsContainer.appendChild(setRow);
            }

            // Find the actual form section
            const actualForm = document.getElementById('actual-form');
            if (!actualForm) {
                console.error('Actual form section not found');
                return;
            }

            // Create a new structure for the form
            actualForm.innerHTML = `
                <div class="form-group">
                    <label for="actual-difficulty">Difficulty:</label>
                    <select id="actual-difficulty" required>
                        <option value="easy" ${isEditing && exercise.difficulty === 'easy' ? 'selected' : ''}>Too Easy</option>
                        <option value="moderate" ${!isEditing || exercise.difficulty === 'moderate' ? 'selected' : ''}>Just Right</option>
                        <option value="hard" ${isEditing && exercise.difficulty === 'hard' ? 'selected' : ''}>Too Hard</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="actual-notes">Notes:</label>
                    <textarea id="actual-notes" rows="2" placeholder="How did it feel? Any issues?">${isEditing && exercise.notes ? exercise.notes : ''}</textarea>
                </div>
            `;

            // Insert the sets container at the beginning of the form
            actualForm.insertBefore(setsContainer, actualForm.firstChild);
            
            // Store exercise reference for the log form
            const logExerciseIdInput = document.getElementById('log-exercise-id');
            const logDayIndexInput = document.getElementById('log-day-index');

            if (logExerciseIdInput) logExerciseIdInput.value = exerciseIndex;
            if (logDayIndexInput) logDayIndexInput.value = workoutLog.dayIndex;
            
            // Show the modal
            const logExerciseModal = document.getElementById('logExerciseModal');
            if (logExerciseModal) {
                logExerciseModal.style.display = 'flex';
            }
            
            // Add event listeners for modal buttons
            const saveLogBtn = document.getElementById('save-log');
            const substituteExerciseBtn = document.getElementById('substitute-exercise');
            const skipExerciseBtn = document.getElementById('skip-exercise');
            const cancelLogBtn = document.getElementById('cancel-log');

            if (saveLogBtn) {
                saveLogBtn.textContent = isEditing ? 'Update' : 'Save';
                saveLogBtn.onclick = function(e) {
                    e.preventDefault();
                    saveExerciseLog(workoutLog, exerciseIndex);
                };
            }
            
            if (substituteExerciseBtn) {
                substituteExerciseBtn.style.display = isEditing ? 'none' : 'block';
                substituteExerciseBtn.onclick = function() {
                    openSubstituteModal(workoutLog, exerciseIndex);
                };
            }
            
            if (skipExerciseBtn) {
                skipExerciseBtn.style.display = isEditing ? 'none' : 'block';
                skipExerciseBtn.onclick = function() {
                    skipExercise(workoutLog, exerciseIndex);
                };
            }
            
            if (cancelLogBtn) {
                cancelLogBtn.onclick = closeLogExerciseModal;
            }
        }
        
        function closeLogExerciseModal() {
            logExerciseModal.style.display = 'none';
            logExerciseForm.reset();
        }
        
        // Function to save all data to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('fitnessEntries', JSON.stringify(entries));
            localStorage.setItem('mesocycle', JSON.stringify(mesocycle));
            localStorage.setItem('workoutLogs', JSON.stringify(workoutLogs));
        }

        // Function to update the workout display
        function updateWorkoutDisplay(date) {
            // Reload data from localStorage
            workoutLogs = JSON.parse(localStorage.getItem('workoutLogs')) || {};
            loadWorkoutForDate(date);
            updateWelcomeTab();
        }

        function saveExerciseLog(workoutLog, exerciseIndex) {
            const exercise = workoutLog.exercises[exerciseIndex];
            
            // Get values from form
            const difficulty = document.getElementById('actual-difficulty').value;
            const notes = document.getElementById('actual-notes').value.trim();
            
            // Get reps and weights for each set
            const actualRepsPerSet = [];
            const actualWeightPerSet = [];
            for (let i = 0; i < exercise.sets; i++) {
                const repsInput = document.getElementById(`actualRepsSet${i}`);
                const weightInput = document.getElementById(`actualWeightSet${i}`);
                actualRepsPerSet.push(parseInt(repsInput.value));
                actualWeightPerSet.push(parseFloat(weightInput.value));
            }
            
            // Update exercise data
            exercise.status = 'completed';
            exercise.actualSets = exercise.sets; // Use planned sets since we're not modifying this
            exercise.actualRepsPerSet = actualRepsPerSet;
            exercise.actualWeightPerSet = actualWeightPerSet;
            exercise.difficulty = difficulty;
            exercise.notes = notes;
            
            // Calculate average weight for summary displays
            exercise.actualWeight = Math.round(actualWeightPerSet.reduce((a, b) => a + b, 0) / actualWeightPerSet.length * 10) / 10;
            
            // Check if all exercises are completed
            const allCompleted = workoutLog.exercises.every(ex => 
                ex.status === 'completed' || ex.status === 'skipped' || ex.status === 'modified'
            );
            
            if (allCompleted) {
                workoutLog.status = 'completed';
            } else {
                workoutLog.status = 'in_progress';
            }
            
            // Save to local storage
            saveToLocalStorage();
            
            // Update UI
            updateWorkoutDisplay(workoutLog.date);
            
            // Close modal
            const logExerciseModal = document.getElementById('logExerciseModal');
            if (logExerciseModal) {
                logExerciseModal.style.display = 'none';
            }
        }
        
        function skipExercise(workoutLog, exerciseIndex) {
            const exercise = workoutLog.exercises[exerciseIndex];
            
            // Mark exercise as skipped
            exercise.status = 'skipped';
            
            // Check if all exercises are completed or skipped
            const allDone = workoutLog.exercises.every(ex => 
                ex.status === 'completed' || ex.status === 'skipped' || ex.status === 'modified'
            );
            
            if (allDone) {
                workoutLog.status = 'completed';
            } else {
                workoutLog.status = 'in_progress';
            }
            
            // Save to localStorage
            localStorage.setItem('workoutLogs', JSON.stringify(workoutLogs));
            
            // Close modal and refresh display
            closeLogExerciseModal();
            loadWorkoutForDate(workoutLog.date);
            updateWelcomeTab();
        }
        
        // Close substitute modal
        function closeSubstituteModal() {
            substituteModal.style.display = 'none';
            currentSubstituteTarget = null;
        }
        
        // Cancel substitute
        cancelSubstituteBtn.addEventListener('click', closeSubstituteModal);
        
        // Update overall workout status
        function updateWorkoutStatus(date) {
            const log = workoutLogs[date];
            if (!log) return;
            
            const exerciseStatuses = log.exercises.map(ex => ex.status);
            
            if (exerciseStatuses.every(status => status === 'completed' || status === 'modified')) {
                log.status = 'completed';
            } else if (exerciseStatuses.some(status => status === 'completed' || status === 'modified')) {
                log.status = 'completed'; // Partial completion is still completion
            } else if (exerciseStatuses.every(status => status === 'missed')) {
                log.status = 'missed';
            } else {
                log.status = 'planned';
            }
        }
        
        // Mark all exercises as completed
        markCompletedBtn.addEventListener('click', function() {
            const date = trackerDateInput.value;
            const log = workoutLogs[date];
            
            if (!log) return;
            
            log.exercises.forEach(exercise => {
                if (exercise.status === 'planned') {
                    exercise.status = 'completed';
                    exercise.actualSets = exercise.sets;
                    exercise.actualReps = exercise.reps;
                    exercise.actualWeight = exercise.weight;
                    exercise.difficulty = 'moderate';
                }
            });
            
            log.status = 'completed';
            
            // Save changes
            localStorage.setItem('workoutLogs', JSON.stringify(workoutLogs));
            
            // Update UI
            loadWorkoutForDate(date);
        });
        
        // Skip whole workout
        skipWorkoutBtn.addEventListener('click', function() {
            const date = trackerDateInput.value;
            const log = workoutLogs[date];
            
            if (!log) return;
            
            if (confirm('Are you sure you want to mark this entire workout as skipped?')) {
                log.exercises.forEach(exercise => {
                    if (exercise.status === 'planned') {
                        exercise.status = 'missed';
                    }
                });
                
                log.status = 'missed';
                
                // Save changes
                localStorage.setItem('workoutLogs', JSON.stringify(workoutLogs));
                
                // Update UI
                loadWorkoutForDate(date);
            }
        });
        
        // Date change in tracker
        trackerDateInput.addEventListener('change', function() {
            loadWorkoutTracker();
        });
        
        // Run initialization
        init();

        // Substitute exercise functionality
        function openSubstituteModal(workoutLog, exerciseIndex) {
            // Store current exercise for substitution
            currentSubstituteTarget = {
                workoutLog,
                exerciseIndex
            };
            
            // Clear previous search
            substituteSearchInput.value = '';
            customSubstituteInput.value = '';
            
            // Show modal
            substituteModal.style.display = 'flex';
            
            // Render initial options
            renderSubstituteOptions();
        }
        
        function renderSubstituteOptions(searchTerm = '') {
            substituteExercises.innerHTML = '';
            
            // Filter exercises based on search term
            const filteredExercises = exerciseDatabase.filter(exercise => {
                if (!searchTerm) return true;
                return exercise.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                       exercise.category.toLowerCase().includes(searchTerm.toLowerCase());
            });
            
            // Create exercise options
            filteredExercises.forEach(exercise => {
                const option = document.createElement('div');
                option.className = 'substitute-item';
                option.innerHTML = `
                    <strong>${exercise.name}</strong>
                    <span class="tag">${exercise.category}</span>
                `;
                
                option.addEventListener('click', () => {
                    substituteExercise(exercise.name, exercise.category);
                });
                
                substituteExercises.appendChild(option);
            });
        }
        
        function substituteExercise(name, category) {
            if (!currentSubstituteTarget) return;
            
            const { workoutLog, exerciseIndex } = currentSubstituteTarget;
            const exercise = workoutLog.exercises[exerciseIndex];
            
            // Update exercise with new details
            exercise.name = name;
            exercise.category = category;
            exercise.status = 'modified';
            
            // Save to localStorage
            localStorage.setItem('workoutLogs', JSON.stringify(workoutLogs));
            
            // Close modals
            substituteModal.style.display = 'none';
            closeLogExerciseModal();
            
            // Refresh display
            loadWorkoutForDate(workoutLog.date);
        }
        
        // Add event listeners for substitute functionality
        substituteSearchInput.addEventListener('input', function() {
            renderSubstituteOptions(this.value);
        });
        
        confirmSubstituteBtn.addEventListener('click', function() {
            const customName = customSubstituteInput.value.trim();
            if (customName) {
                substituteExercise(customName, 'other');
            }
        });
        
        cancelSubstituteBtn.addEventListener('click', function() {
            substituteModal.style.display = 'none';
        });

        // Update Welcome tab content
        function updateWelcomeTab() {
            // Update today's stats
            const today = new Date().toISOString().split('T')[0];
            const todayEntry = entries.find(entry => entry.date === today);
            
            if (todayEntry) {
                const weightKg = todayEntry.weightKg;
                const weightLbs = weightKg ? kgToLbs(weightKg).toFixed(1) : '--';
                document.getElementById('welcome-weight').textContent = 
                    weightKg ? `${weightKg.toFixed(1)} kg / ${weightLbs} lbs` : '--';
                
                const netCalories = todayEntry.netCalories;
                const welcomeCalories = document.getElementById('welcome-calories');
                welcomeCalories.textContent = netCalories;
                welcomeCalories.className = netCalories > 0 ? 'negative' : 'positive';
            } else {
                document.getElementById('welcome-weight').textContent = '--';
                document.getElementById('welcome-calories').textContent = '--';
            }
            
            // Update 30-day weight change
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentEntries = entries.filter(entry => 
                entry.weightKg !== null && new Date(entry.date) >= thirtyDaysAgo
            ).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (recentEntries.length >= 2) {
                const oldestWeight = recentEntries[0].weightKg;
                const latestWeight = recentEntries[recentEntries.length - 1].weightKg;
                const change = latestWeight - oldestWeight;
                const changeLbs = Math.abs(kgToLbs(change)).toFixed(1);
                const direction = change < 0 ? 'loss' : 'gain';
                
                const welcomeWeightChange = document.getElementById('welcome-weight-change');
                welcomeWeightChange.textContent = 
                    `${Math.abs(change).toFixed(1)} kg / ${changeLbs} lbs ${direction}`;
                welcomeWeightChange.className = direction === 'loss' ? 'positive' : 'negative';
            } else {
                document.getElementById('welcome-weight-change').textContent = '--';
            }
            
            // Update workout completion stats
            let completedWorkouts = 0;
            let totalWorkouts = 0;
            
            Object.values(workoutLogs).forEach(log => {
                if (log.type === 'workout') {
                    totalWorkouts++;
                    if (log.status === 'completed') {
                        completedWorkouts++;
                    }
                }
            });
            
            document.getElementById('welcome-workouts').textContent = 
                `${completedWorkouts} / ${totalWorkouts}`;
            
            // Update today's workout
            const welcomeWorkout = document.getElementById('welcome-workout');
            const todayWorkout = workoutLogs[today];
            
            if (todayWorkout) {
                if (todayWorkout.type === 'rest') {
                    welcomeWorkout.innerHTML = `
                        <p>Today is a rest day</p>
                        <button onclick="switchTab('workout-tracker')" class="btn-primary" style="margin-top: 10px;">
                            Change Workout
                        </button>
                    `;
                } else {
                    let statusClass = '';
                    switch(todayWorkout.status) {
                        case 'completed':
                            statusClass = 'completed';
                            break;
                        case 'in_progress':
                            statusClass = 'in-progress';
                            break;
                        default:
                            statusClass = 'planned';
                    }
                    
                    const exerciseList = todayWorkout.exercises
                        .map(ex => `<div>• ${ex.name}</div>`)
                        .join('');
                    
                    welcomeWorkout.innerHTML = `
                        <p>${todayWorkout.dayName}</p>
                        <span class="workout-status ${statusClass}">
                            ${todayWorkout.status.charAt(0).toUpperCase() + todayWorkout.status.slice(1)}
                        </span>
                        <div class="exercise-list">
                            ${exerciseList}
                        </div>
                        <button onclick="switchTab('workout-tracker')" class="btn-primary" style="margin-top: 10px;">
                            Go to Workout
                        </button>
                    `;
                }
            } else {
                welcomeWorkout.innerHTML = `
                    <p>No workout planned for today</p>
                    <button onclick="switchTab('workout-tracker')" class="btn-primary" style="margin-top: 10px;">
                        Plan Workout
                    </button>
                `;
            }
        }
        
        // Update welcome tab when switching back to it
        function switchTab(tabId) {
            // Update tab button active state
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update tab content visibility
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Special actions when switching to specific tabs
            if (tabId === 'workout-plan') {
                renderWorkoutPlan();
            } else if (tabId === 'workout-tracker') {
                loadWorkoutTracker();
            } else if (tabId === 'welcome') {
                updateWelcomeTab();
            }
        }

        // Mobile interaction handlers
        function initializeMobileInteractions() {
            // Modal touch gesture handling
            document.querySelectorAll('.modal').forEach(modal => {
                let startY = 0;
                let currentY = 0;
                let isDragging = false;
                
                const modalContent = modal.querySelector('.modal-content');
                
                modalContent.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    startY = touch.clientY;
                    currentY = startY;
                    isDragging = true;
                    
                    modalContent.style.transition = 'none';
                });
                
                modalContent.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    
                    const touch = e.touches[0];
                    const deltaY = touch.clientY - startY;
                    
                    // Only allow dragging down
                    if (deltaY < 0) return;
                    
                    currentY = touch.clientY;
                    
                    // Apply transform with resistance
                    const resistance = 0.5;
                    const transform = Math.min(deltaY * resistance, window.innerHeight);
                    modalContent.style.transform = `translateY(${transform}px)`;
                    
                    // Adjust opacity of modal background
                    const opacity = Math.max(0.5, 1 - (transform / window.innerHeight));
                    modal.style.backgroundColor = `rgba(0, 0, 0, ${opacity})`;
                });
                
                const endDrag = (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    modalContent.style.transition = 'all 0.3s ease';
                    
                    const deltaY = currentY - startY;
                    const threshold = window.innerHeight * 0.2; // 20% of screen height
                    
                    if (deltaY > threshold) {
                        // Close the modal
                        modal.classList.add('closing');
                        setTimeout(() => {
                            modal.style.display = 'none';
                            modal.classList.remove('closing');
                            modalContent.style.transform = '';
                            modal.style.backgroundColor = '';
                            document.body.classList.remove('modal-open');
                        }, 300);
                    } else {
                        // Reset the modal position
                        modalContent.style.transform = '';
                        modal.style.backgroundColor = '';
                    }
                };
                
                modalContent.addEventListener('touchend', endDrag);
                modalContent.addEventListener('touchcancel', endDrag);
            });
            
            // Prevent body scroll when modal is open
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (modal.style.display === 'flex') {
                                document.body.classList.add('modal-open');
                            } else {
                                document.body.classList.remove('modal-open');
                            }
                        }
                    });
                });
                
                observer.observe(modal, { attributes: true });
            });
        }

        // Initialize mobile interactions when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeMobileInteractions();
        });

        // Mobile workout tracking interactions
        function initializeWorkoutTracking() {
            const exerciseCards = document.querySelectorAll('.exercise-card');
            
            exerciseCards.forEach(card => {
                let startX = 0;
                let currentX = 0;
                let isDragging = false;
                
                // Add swipe actions
                const swipeActions = document.createElement('div');
                swipeActions.className = 'swipe-actions';
                
                const completeAction = document.createElement('div');
                completeAction.className = 'swipe-action swipe-complete';
                completeAction.innerHTML = '✓';
                
                const skipAction = document.createElement('div');
                skipAction.className = 'swipe-action swipe-skip';
                skipAction.innerHTML = '×';
                
                swipeActions.appendChild(completeAction);
                swipeActions.appendChild(skipAction);
                card.appendChild(swipeActions);
                
                // Touch event handlers
                card.addEventListener('touchstart', (e) => {
                    if (e.target.closest('.exercise-actions')) return;
                    
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    currentX = startX;
                    isDragging = true;
                    
                    card.classList.add('swiping');
                });
                
                card.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    
                    const touch = e.touches[0];
                    currentX = touch.clientX;
                    const deltaX = currentX - startX;
                    
                    // Only allow swiping left
                    if (deltaX > 0) return;
                    
                    // Apply transform with resistance
                    const resistance = 0.5;
                    const transform = Math.max(deltaX * resistance, -150);
                    card.style.transform = `translateX(${transform}px)`;
                    
                    // Show swipe actions
                    swipeActions.style.transform = `translateX(${transform + 150}px)`;
                });
                
                const endSwipe = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    card.classList.remove('swiping');
                    
                    const deltaX = currentX - startX;
                    const threshold = -100;
                    
                    if (deltaX < threshold) {
                        // Show action sheet
                        showActionSheet(card);
                    }
                    
                    // Reset position
                    card.style.transform = '';
                    swipeActions.style.transform = '';
                };
                
                card.addEventListener('touchend', endSwipe);
                card.addEventListener('touchcancel', endSwipe);
            });
            
            // Action sheet handling
            let currentActionSheet = null;
            let currentOverlay = null;
            
            function showActionSheet(exerciseCard) {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.className = 'action-sheet-overlay';
                document.body.appendChild(overlay);
                
                // Create action sheet
                const actionSheet = document.createElement('div');
                actionSheet.className = 'action-sheet';
                actionSheet.innerHTML = `
                    <h3>Exercise Actions</h3>
                    <div class="action-sheet-buttons">
                        <button class="btn-success" data-action="complete">Complete Exercise</button>
                        <button class="btn-warning" data-action="modify">Modify Exercise</button>
                        <button class="btn-danger" data-action="skip">Skip Exercise</button>
                        <button class="btn-secondary" data-action="cancel">Cancel</button>
                    </div>
                `;
                document.body.appendChild(actionSheet);
                
                // Show overlay and action sheet
                requestAnimationFrame(() => {
                    overlay.classList.add('visible');
                    actionSheet.classList.add('visible');
                });
                
                currentActionSheet = actionSheet;
                currentOverlay = overlay;
                
                // Handle button clicks
                actionSheet.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    const action = button.dataset.action;
                    
                    switch (action) {
                        case 'complete':
                            completeExercise(exerciseCard);
                            break;
                        case 'modify':
                            modifyExercise(exerciseCard);
                            break;
                        case 'skip':
                            skipExercise(exerciseCard);
                            break;
                    }
                    
                    hideActionSheet();
                });
                
                // Close on overlay click
                overlay.addEventListener('click', hideActionSheet);
            }
            
            function hideActionSheet() {
                if (currentActionSheet && currentOverlay) {
                    currentActionSheet.classList.remove('visible');
                    currentOverlay.classList.remove('visible');
                    
                    setTimeout(() => {
                        currentActionSheet.remove();
                        currentOverlay.remove();
                        currentActionSheet = null;
                        currentOverlay = null;
                    }, 300);
                }
            }
            
            // Exercise action handlers
            function completeExercise(card) {
                const exerciseId = card.dataset.exerciseId;
                // Call your existing complete exercise logic here
                console.log('Complete exercise:', exerciseId);
            }
            
            function modifyExercise(card) {
                const exerciseId = card.dataset.exerciseId;
                // Call your existing modify exercise logic here
                console.log('Modify exercise:', exerciseId);
            }
            
            function skipExercise(card) {
                const exerciseId = card.dataset.exerciseId;
                // Call your existing skip exercise logic here
                console.log('Skip exercise:', exerciseId);
            }
            
            // Progress tracking
            function updateWorkoutProgress() {
                const totalExercises = exerciseCards.length;
                let completedExercises = 0;
                
                exerciseCards.forEach(card => {
                    if (card.classList.contains('completed')) {
                        completedExercises++;
                    }
                });
                
                const progressBar = document.querySelector('.progress-fill');
                if (progressBar) {
                    const progress = (completedExercises / totalExercises) * 100;
                    progressBar.style.width = `${progress}%`;
                }
            }
            
            // Initialize progress tracking
            updateWorkoutProgress();
        }

        // Add to the existing DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', () => {
            initializeMobileInteractions();
            initializeWorkoutTracking();
        });

        // Device toggle functionality
        const deviceToggle = document.getElementById('deviceToggle');
        deviceToggle.addEventListener('click', () => {
            document.body.classList.toggle('mobile-preview');
            deviceToggle.textContent = document.body.classList.contains('mobile-preview') 
                ? 'Exit Mobile Preview' 
                : 'Toggle Mobile Preview';
        });

        // Preserve existing tab functionality
        const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
        let moreMenuOpen = false;

        mobileNavItems.forEach(item => {
            item.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                
                if (tab === 'more') {
                    handleMoreMenu();
                    return;
                }
                
                // Use existing switchTab function
                switchTab(tab);
                
                // Update active state
                mobileNavItems.forEach(navItem => navItem.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function handleMoreMenu() {
            if (!moreMenuOpen) {
                // Create more menu
                moreMenu = document.createElement('div');
                moreMenu.className = 'more-menu';
                moreMenu.style.cssText = `
                    position: fixed;
                    bottom: calc(var(--nav-height) + env(safe-area-inset-bottom, 0px));
                    left: 0;
                    right: 0;
                    background: white;
                    border-top-left-radius: 12px;
                    border-top-right-radius: 12px;
                    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                    padding: 16px;
                    z-index: 999;
                    max-width: 390px;
                    margin: 0 auto;
                `;
                
                const menuItems = [
                    { tab: 'graphs', label: 'Graphs', icon: 'M16,11.78L20.24,4.45L21.97,5.45L16.74,14.5L10.23,10.75L5.46,19H22V21H2V3H4V17.54L9.5,8L16,11.78Z' },
                    { tab: 'history', label: 'History', icon: 'M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3A9,9 0 0,0 4,12H1L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19A7,7 0 0,1 6,12H4A9,9 0 0,0 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3' },
                    { tab: 'workout-plan', label: 'Plan', icon: 'M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z' }
                ];
                
                menuItems.forEach(item => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'mobile-nav-item';
                    menuItem.setAttribute('data-tab', item.tab);
                    menuItem.innerHTML = `
                        <svg class="mobile-nav-icon" viewBox="0 0 24 24">
                            <path d="${item.icon}" />
                        </svg>
                        <span class="mobile-nav-label">${item.label}</span>
                    `;
                    menuItem.addEventListener('click', () => {
                        switchTab(item.tab);
                        closeMoreMenu();
                    });
                    moreMenu.appendChild(menuItem);
                });
                
                document.body.appendChild(moreMenu);
                moreMenuOpen = true;
                
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', handleOutsideClick);
                }, 100);
            } else {
                closeMoreMenu();
            }
        }

        function closeMoreMenu() {
            if (moreMenu && moreMenu.parentNode) {
                moreMenu.parentNode.removeChild(moreMenu);
                moreMenu = null;
                moreMenuOpen = false;
                document.removeEventListener('click', handleOutsideClick);
            }
        }

        function handleOutsideClick(e) {
            if (moreMenu && !moreMenu.contains(e.target) && !e.target.closest('.mobile-nav-item[data-tab="more"]')) {
                closeMoreMenu();
            }
        }

        // Update active state based on current tab
        function updateMobileNavActiveState(tabName) {
            mobileNavItems.forEach(item => {
                if (item.getAttribute('data-tab') === tabName) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Hook into the existing switchTab function
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            originalSwitchTab(tabName);
            updateMobileNavActiveState(tabName);
        };
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>